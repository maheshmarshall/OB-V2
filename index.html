<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Management UI</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the page */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple animation for button hover */
        .btn-hover-effect {
            transition: all 0.2s ease-in-out;
        }
        .btn-hover-effect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .active-btn {
            background-color: #3B82F6; /* blue-500 */
            color: white;
        }
        .action-btn-active {
            background-color: #2563EB; /* blue-600 */
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-btn-active {
            background-color: #10B981; /* green-500 */
            color: white;
        }
        /* Custom scrollbar for category list */
        .category-list::-webkit-scrollbar {
            width: 8px;
        }
        .category-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .category-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .category-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Styles for modals */
        .modal-hidden {
            display: none;
        }
        .autosize-person-textarea {
            resize: none;
            overflow-y: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Action</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirm-modal-message" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Confirm
                    </button>
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Notification Modal -->
    <div id="success-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="success-modal-title" class="text-lg leading-6 font-medium text-gray-900">Success</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="success-modal-message" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="success-modal-ok-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full bg-gray-800 p-2 text-white flex justify-end items-center">
        <label for="login-as-select" class="text-sm mr-2">Currently logged in as:</label>
        <select id="login-as-select" class="bg-gray-700 text-white p-1 rounded-md text-sm"></select>
    </div>


    <div class="container mx-auto p-4 md:p-8">
        <div class="flex flex-col md:flex-row bg-white rounded-xl shadow-lg min-h-[80vh]">
            
            <!-- Sidebar Navigation -->
            <aside class="w-full md:w-64 p-6 border-b md:border-b-0 md:border-r border-gray-200">
                <nav id="sidebar-nav" class="space-y-4">
                    <!-- Navigation Button: OB Entry -->
                    <button id="ob-entry-btn" data-view="ob-entry-view" class="w-full flex items-center justify-between p-3 rounded-lg bg-blue-500 text-white font-semibold shadow-md btn-hover-effect">
                        <span>OB Entry</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                    <!-- Navigation Button: Category Edit -->
                    <button data-view="category-edit-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Category Edit</button>
                    
                    <!-- Other Navigation Buttons -->
                    <button data-view="recoveries-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Recoveries</button>
                    <button data-view="complaints-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Complaints</button>
                    <button data-view="positive-arrests-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Positive Arrests</button>
                    <button data-view="sot-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">SOT Positives</button>
                    <button data-view="manage-users-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Manage Users</button>
                    <button data-view="user-permissions-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">User Permissions</button>
                </nav>
            </aside>

            <!-- Main Content Area -->
            <main id="main-content" class="flex-1 p-6 md:p-10 overflow-auto">
                <!-- OB Entry View (Now visible by default) -->
                <div id="ob-entry-view" class="view-panel">
                    <div id="ob-actions" class="flex justify-center space-x-4 mb-6">
                        <button data-action="add" class="ob-action-btn px-6 py-2 rounded-lg bg-blue-500 text-white font-semibold shadow-md btn-hover-effect action-btn-active">Add Record</button>
                        <button data-action="remove" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Remove Record</button>
                        <button data-action="update" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Update Record</button>
                        <button data-action="view" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">View Record</button>
                    </div>

                    <div class="border rounded-lg p-6 bg-gray-50">
                        <div class="flex justify-between items-center border-b pb-4 mb-6">
                            <h2 class="text-xl font-bold text-gray-800">Occurrence Book</h2>
                            <span class="text-sm font-medium text-gray-600">UID:</span>
                        </div>
                        
                        <form id="ob-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">OB Number:</label>
                                    <span id="ob-number-display" class="font-bold text-gray-800"></span>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Created:</label>
                                    <span id="created-date" class="text-gray-800"></span>
                                </div>
                            </div>
                            <div class="grid grid-cols-1">
                                <div class="flex items-center">
                                    <label class="w-48 text-gray-600 font-medium">Time of Incident:</label>
                                    <span class="mr-2">From</span>
                                    <input type="datetime-local" class="p-2 border rounded-md w-full">
                                    <span class="mx-2">To</span>
                                    <input type="datetime-local" class="p-2 border rounded-md w-full">
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Created By:</label>
                                    <span class="text-gray-800">Mahesh Palad</span>
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">OB Type<span class="text-red-500">*</span>:</label>
                                    <select id="ob-type-select" class="p-2 border rounded-md w-2/3"></select>
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">OB Category:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Police Station:</label>
                                    <select id="police-station-select" class="p-2 border rounded-md w-2/3"></select>
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">CAS Number:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">SAP 13 Number:</label>
                                    <div class="w-2/3 sap-container">
                                        <input type="text" class="p-2 border rounded-md numeric-only autosize-input w-full mb-2" placeholder="Number">
                                        <div class="flex items-center space-x-2">
                                            <select class="p-2 border rounded-md sap-month"></select>
                                            <span class="text-gray-500">/</span>
                                            <select class="p-2 border rounded-md sap-year"></select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Requires Followup:</label>
                                    <input type="checkbox" class="h-5 w-5">
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Follow up User:</label>
                                    <select id="follow-up-user-select" class="p-2 border rounded-md w-2/3"></select>
                                </div>
                            </div>
                            
                            <!-- Location Information Section -->
                            <div id="ob-location-info-section" class="border-t pt-6 mt-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Location Information</h3>
                                <div class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="flex items-center">
                                            <label class="w-1/3 text-gray-600 font-medium">Area:</label>
                                            <div class="flex w-2/3">
                                                <select id="area-select" class="p-2 border rounded-md w-full"></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="flex items-center">
                                            <label class="w-1/3 text-gray-600 font-medium">Client:</label>
                                            <div class="flex items-center w-2/3">
                                                <span class="text-gray-800 mr-4">Recorded as Non-Client</span>
                                                <button type="button" class="px-4 py-2 bg-blue-500 text-white rounded-md btn-hover-effect">Lookup</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                        <div class="flex items-center">
                                            <label class="w-1/3 text-gray-600 font-medium">Client Account:</label>
                                            <input type="text" class="p-2 border rounded-md w-2/3">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                        <div class="flex items-center">
                                            <label class="w-1/3 text-gray-600 font-medium">Contact No:</label>
                                            <input type="text" class="p-2 border rounded-md w-2/3 numeric-only autosize-input">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 gap-6 bg-blue-50 p-4 rounded-md">
                                         <div class="flex">
                                            <label class="w-1/6 text-gray-600 font-medium">Address:</label>
                                            <div class="w-5/6 space-y-2">
                                                <input type="text" class="p-2 border rounded-md w-full">
                                                <input type="text" class="p-2 border rounded-md w-full">
                                                <input type="text" class="p-2 border rounded-md w-full">
                                            </div>
                                        </div>
                                    </div>
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                        <div class="flex items-center">
                                            <label class="w-1/3 text-gray-600 font-medium">Latitude:</label>
                                            <input type="text" class="p-2 border rounded-md w-2/3">
                                        </div>
                                         <div class="flex items-center">
                                            <label class="w-1/3 text-gray-600 font-medium">Longitude:</label>
                                            <input type="text" class="p-2 border rounded-md w-2/3">
                                        </div>
                                    </div>
                                     <div class="grid grid-cols-1 gap-6">
                                         <div class="flex">
                                            <label class="w-1/6 text-gray-600 font-medium">Comments:</label>
                                            <textarea class="p-2 border rounded-md w-5/6 h-24"></textarea>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="flex items-center">
                                            <label class="w-1/3 text-gray-600 font-medium">Status:</label>
                                            <div id="status-buttons" class="flex space-x-2">
                                                <button type="button" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700 status-btn-active">Open</button>
                                                <button type="button" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700">Closed</button>
                                                <button type="button" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700">Pending</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Save Button -->
                            <div class="flex justify-end pt-4">
                                <button type="button" id="save-record-btn" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save Record</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Category Edit View -->
                <div id="category-edit-view" class="view-panel hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Category Editor</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label for="category-selector" class="block text-sm font-medium text-gray-700 mb-2">Select a category to edit:</label>
                            <select id="category-selector" class="w-full p-2 border rounded-md">
                                <option value="obType">OB Type</option>
                                <option value="policeStation">Police Station</option>
                                <option value="followUpUser">Follow up User</option>
                                <option value="area">Area</option>
                                <option value="vehicleMake">Vehicle Make</option>
                                <option value="ethnicity">Ethnicity</option>
                                <option value="division">Division</option>
                                <option value="recoveryType">Recovery Type</option>
                                <option value="incidentType">Incident Type</option>
                                <option value="natureOfCrime">Nature of Crime</option>
                                <option value="sotPersonAssigned">SOT Person Assigned</option>
                                <option value="department">Department</option>
                                <option value="role">Role</option>
                            </select>
                        </div>
                        <div id="editor-panel">
                            <h3 id="editing-category-name" class="text-xl font-semibold mb-4"></h3>
                            <div class="bg-gray-50 border rounded-lg p-4">
                                <div class="mb-4">
                                    <label for="new-item-input" class="block text-sm font-medium text-gray-700">Add new item:</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="text" id="new-item-input" class="flex-1 block w-full rounded-none rounded-l-md p-2 border-gray-300" placeholder="New category item">
                                        <button id="add-item-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 hover:bg-gray-100">Add</button>
                                    </div>
                                </div>
                                <div id="category-item-list" class="category-list max-h-80 overflow-y-auto space-y-2">
                                    <!-- Items will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recoveries View -->
                <div id="recoveries-view" class="view-panel hidden">
                    <div id="recoveries-actions" class="flex justify-center space-x-4 mb-6">
                        <button data-action="add" class="ob-action-btn px-6 py-2 rounded-lg bg-blue-500 text-white font-semibold shadow-md btn-hover-effect action-btn-active">Add Record</button>
                        <button data-action="remove" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Remove Record</button>
                        <button data-action="update" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Update Record</button>
                        <button data-action="view" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">View Record</button>
                    </div>
                    <div class="border rounded-lg p-6 bg-gray-50">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">Recoveries</h2>
                        <form id="recoveries-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Date and Time:</label>
                                    <input type="datetime-local" class="p-2 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Name:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Division:</label>
                                    <select id="recovery-division-select" class="p-2 border rounded-md w-2/3"></select>
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Recovery Type:</label>
                                    <select id="recovery-type-select" class="p-2 border rounded-md w-2/3"></select>
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Incident Type:</label>
                                    <select id="recovery-incident-type-select" class="p-2 border rounded-md w-2/3"></select>
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Duration of Incident:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Registration:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Vin Number:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Items Recovered:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                 <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Quantity of items:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3 numeric-only">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Vehicle Brand:</label>
                                    <select id="recovery-vehicle-brand-select" class="p-2 border rounded-md w-2/3"></select>
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Make of vehicle:</label>
                                     <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Police Station (From):</label>
                                    <select id="recovery-ps-from-select" class="p-2 border rounded-md w-2/3"></select>
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Case number:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Police Station (Recovered):</label>
                                    <select id="recovery-ps-recovered-select" class="p-2 border rounded-md w-2/3"></select>
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">SAPS 13 Number:</label>
                                    <div class="w-2/3 sap-container">
                                        <input type="text" class="p-2 border rounded-md numeric-only autosize-input w-full mb-2" placeholder="Number">
                                        <div class="flex items-center space-x-2">
                                            <select class="p-2 border rounded-md sap-month"></select>
                                            <span class="text-gray-500">/</span>
                                            <select class="p-2 border rounded-md sap-year"></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Estimated Value of vehicle:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3 currency-rand">
                                </div>
                                 <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Estimated Value of Items:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3 currency-rand">
                                </div>
                                 <div class="flex items-center col-span-1 md:col-span-2">
                                    <label class="w-1/6 text-gray-600 font-medium">Address Of Incident:</label>
                                    <textarea class="p-2 border rounded-md w-5/6 h-20"></textarea>
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Coordinates (Recovery):</label>
                                    <div class="flex w-2/3 gap-2">
                                        <input type="text" placeholder="Latitude" class="p-2 border rounded-md w-1/2 decimal-only">
                                        <input type="text" placeholder="Longitude" class="p-2 border rounded-md w-1/2 decimal-only">
                                    </div>
                                </div>
                                 <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Marshall OB number:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Recovered by:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Photo of Vehicle Stolen:</label>
                                    <input type="file" class="p-1 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Photo of Items Stolen:</label>
                                    <input type="file" class="p-1 border rounded-md w-2/3">
                                </div>
                            </div>
                             <div class="flex justify-end pt-4">
                                <button type="button" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save Recovery</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Complaints View -->
                <div id="complaints-view" class="view-panel hidden flex items-center justify-center h-full border-2 border-dashed border-gray-300 rounded-xl">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-500">Complaints</h1>
                </div>

                <!-- Positive Arrests View -->
                <div id="positive-arrests-view" class="view-panel hidden">
                     <div id="positive-arrests-actions" class="flex justify-center space-x-4 mb-6">
                        <button data-action="add" class="ob-action-btn px-6 py-2 rounded-lg bg-blue-500 text-white font-semibold shadow-md btn-hover-effect action-btn-active">Add Record</button>
                        <button data-action="remove" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Remove Record</button>
                        <button data-action="update" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Update Record</button>
                        <button data-action="view" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">View Record</button>
                    </div>
                    <div class="border rounded-lg p-6 bg-gray-50">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">Positive Arrests</h2>
                        <form id="positive-arrests-form" class="space-y-6">
                            <!-- Basic Info -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Date Time Captured:</label>
                                    <input type="datetime-local" class="p-2 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Information Entered by:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Division:</label>
                                    <select id="pa-division-select" class="p-2 border rounded-md w-2/3"></select>
                                </div>
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Date:</label>
                                    <input type="date" class="p-2 border rounded-md w-2/3">
                                </div>
                                <div class="flex items-center col-span-1 md:col-span-2">
                                    <label class="w-1/6 text-gray-600 font-medium">Address of Crime:</label>
                                    <textarea class="p-2 border rounded-md w-5/6 h-20"></textarea>
                                </div>
                            </div>

                            <!-- Crime Details Sections -->
                            <div id="pa-crime-details-section" class="space-y-4">
                                <!-- Crime 1 -->
                                <div class="border-t pt-4 mt-4">
                                     <h3 class="text-lg font-semibold text-gray-700 mb-4">Crime 1</h3>
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">Nature of Crime:</label>
                                             <select class="pa-nature-crime-select p-2 border rounded-md w-2/3"></select>
                                         </div>
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">Police station:</label>
                                             <select class="pa-police-station-select p-2 border rounded-md w-2/3"></select>
                                         </div>
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">SAPS Case number:</label>
                                             <input type="text" class="p-2 border rounded-md w-2/3">
                                         </div>
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">SAPS 13 Number:</label>
                                             <div class="w-2/3 sap-container">
                                                 <input type="text" class="p-2 border rounded-md numeric-only autosize-input w-full mb-2" placeholder="Number">
                                                 <div class="flex items-center space-x-2">
                                                     <select class="p-2 border rounded-md sap-month"></select>
                                                     <span class="text-gray-500">/</span>
                                                     <select class="p-2 border rounded-md sap-year"></select>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                </div>
                                <!-- Crime 2 -->
                                <div class="border-t pt-4 mt-4">
                                     <h3 class="text-lg font-semibold text-gray-700 mb-4">Crime 2</h3>
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">Nature of Crime:</label>
                                             <select class="pa-nature-crime-select p-2 border rounded-md w-2/3"></select>
                                         </div>
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">Police station:</label>
                                             <select class="pa-police-station-select p-2 border rounded-md w-2/3"></select>
                                         </div>
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">SAPS Case number:</label>
                                             <input type="text" class="p-2 border rounded-md w-2/3">
                                         </div>
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">SAPS 13 Number:</label>
                                             <div class="w-2/3 sap-container">
                                                 <input type="text" class="p-2 border rounded-md numeric-only autosize-input w-full mb-2" placeholder="Number">
                                                 <div class="flex items-center space-x-2">
                                                     <select class="p-2 border rounded-md sap-month"></select>
                                                     <span class="text-gray-500">/</span>
                                                     <select class="p-2 border rounded-md sap-year"></select>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                </div>
                                <!-- Crime 3 -->
                                <div class="border-t pt-4 mt-4">
                                     <h3 class="text-lg font-semibold text-gray-700 mb-4">Crime 3</h3>
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">Nature of Crime:</label>
                                             <select class="pa-nature-crime-select p-2 border rounded-md w-2/3"></select>
                                         </div>
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">Police station:</label>
                                             <select class="pa-police-station-select p-2 border rounded-md w-2/3"></select>
                                         </div>
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">SAPS Case number:</label>
                                             <input type="text" class="p-2 border rounded-md w-2/3">
                                         </div>
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">SAPS 13 Number:</label>
                                             <div class="w-2/3 sap-container">
                                                 <input type="text" class="p-2 border rounded-md numeric-only autosize-input w-full mb-2" placeholder="Number">
                                                 <div class="flex items-center space-x-2">
                                                     <select class="p-2 border rounded-md sap-month"></select>
                                                     <span class="text-gray-500">/</span>
                                                     <select class="p-2 border rounded-md sap-year"></select>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                </div>
                                <!-- Crime 4 -->
                                <div class="border-t pt-4 mt-4">
                                     <h3 class="text-lg font-semibold text-gray-700 mb-4">Crime 4</h3>
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">Nature of Crime:</label>
                                             <select class="pa-nature-crime-select p-2 border rounded-md w-2/3"></select>
                                         </div>
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">Police station:</label>
                                             <select class="pa-police-station-select p-2 border rounded-md w-2/3"></select>
                                         </div>
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">SAPS Case number:</label>
                                             <input type="text" class="p-2 border rounded-md w-2/3">
                                         </div>
                                         <div class="flex items-center">
                                             <label class="w-1/3 text-gray-600 font-medium">SAPS 13 Number:</label>
                                             <div class="w-2/3 sap-container">
                                                 <input type="text" class="p-2 border rounded-md numeric-only autosize-input w-full mb-2" placeholder="Number">
                                                 <div class="flex items-center space-x-2">
                                                     <select class="p-2 border rounded-md sap-month"></select>
                                                     <span class="text-gray-500">/</span>
                                                     <select class="p-2 border rounded-md sap-year"></select>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                </div>
                            </div>

                             <!-- Pictures Section -->
                            <div id="pa-evidence-section" class="border-t pt-4 mt-4">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Evidence Pictures</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Pictures of Scene:</label>
                                        <input type="file" multiple class="p-1 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Picture of Statement:</label>
                                        <input type="file" class="p-1 border rounded-md w-2/3">
                                    </div>
                                     <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Picture of Statement 2:</label>
                                        <input type="file" class="p-1 border rounded-md w-2/3">
                                    </div>
                                     <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Picture of Statement 3:</label>
                                        <input type="file" class="p-1 border rounded-md w-2/3">
                                    </div>
                                     <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Picture of Statement 4:</label>
                                        <input type="file" class="p-1 border rounded-md w-2/3">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Suspects Section -->
                            <div id="pa-suspects-section" class="border-t pt-4 mt-4">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Suspect Details</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                     <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Total Suspects:</label>
                                        <input type="text" class="p-2 border rounded-md w-2/3 numeric-only">
                                    </div>
                                </div>
                                <div class="flex justify-end mb-2">
                                    <button type="button" id="add-suspect-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md btn-hover-effect">Add Suspect</button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white border">
                                        <thead class="bg-gray-200">
                                            <tr>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Suspect Name</th>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">ID Number</th>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">ID Picture</th>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="suspects-tbody"></tbody>
                                    </table>
                                </div>
                            </div>

                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                                 <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Arrested By:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                             </div>

                             <div class="flex justify-end pt-4">
                                <button type="button" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save Arrest</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- SOT Positives View -->
                <div id="sot-view" class="view-panel hidden">
                    <div id="sot-actions" class="flex justify-center space-x-4 mb-6">
                        <button data-action="add" class="ob-action-btn px-6 py-2 rounded-lg bg-blue-500 text-white font-semibold shadow-md btn-hover-effect action-btn-active">Add Record</button>
                        <button data-action="remove" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Remove Record</button>
                        <button data-action="update" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Update Record</button>
                        <button data-action="view" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">View Record</button>
                    </div>
                    <div class="border rounded-lg p-6 bg-gray-50">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">SOT Positives</h2>
                        <form id="sot-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Status -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Status:</label>
                                    <div id="sot-status-buttons" class="flex space-x-2">
                                        <button type="button" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700 status-btn-active">Open</button>
                                        <button type="button" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700">Closed</button>
                                        <button type="button" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700">Pending</button>
                                    </div>
                                </div>
                                <!-- Date Opened -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Date Opened:</label>
                                    <input type="datetime-local" class="p-2 border rounded-md w-2/3">
                                </div>
                                <!-- Date Assigned -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Date Assigned:</label>
                                    <input type="datetime-local" class="p-2 border rounded-md w-2/3">
                                </div>
                                <!-- Date Closed -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Date Closed:</label>
                                    <input type="datetime-local" class="p-2 border rounded-md w-2/3">
                                </div>
                                 <!-- Investigation Close Date -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Investigation Close Date:</label>
                                    <input type="date" class="p-2 border rounded-md w-2/3">
                                </div>
                                <!-- Marshall Client -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Marshall Client:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                <!-- Unit number -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Unit number:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                <!-- Business Name -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Business Name:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3">
                                </div>
                                <!-- Incident Type -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Incident Type:</label>
                                    <select id="sot-incident-type-select" class="p-2 border rounded-md w-2/3"></select>
                                </div>
                                <!-- Person Assigned -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Person Assigned:</label>
                                    <select id="sot-person-assigned-select" class="p-2 border rounded-md w-2/3"></select>
                                </div>
                                <!-- Client Contacted -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Client Contacted:</label>
                                    <input type="checkbox" class="h-5 w-5">
                                </div>
                                 <!-- Contact Number -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Contact Number:</label>
                                    <input type="text" class="p-2 border rounded-md w-2/3 numeric-only">
                                </div>
                                <!-- Onsite Meeting -->
                                <div class="flex items-center">
                                    <label class="w-1/3 text-gray-600 font-medium">Onsite Meeting:</label>
                                    <input type="checkbox" class="h-5 w-5">
                                </div>
                            </div>

                            <!-- Textareas and combined fields -->
                            <div class="space-y-4 border-t pt-4 mt-4">
                                 <!-- Address Of Incident -->
                                <div class="flex items-start">
                                    <label class="w-1/4 text-gray-600 font-medium pt-2">Address Of Incident:</label>
                                    <textarea class="p-2 border rounded-md w-3/4" rows="3"></textarea>
                                </div>
                                <!-- History Report -->
                                <div class="flex items-start">
                                    <label class="w-1/4 text-gray-600 font-medium pt-2">History Report:</label>
                                    <input type="file" class="p-1 border rounded-md w-3/4">
                                </div>
                                <!-- Feedback/Investigation -->
                                <div class="flex items-start">
                                    <label class="w-1/4 text-gray-600 font-medium pt-2">Feedback/Investigation:</label>
                                    <textarea class="p-2 border rounded-md w-3/4" rows="4"></textarea>
                                </div>
                            </div>

                            <div id="sot-comments-section" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 border-t pt-4 mt-4">
                                <!-- CCTV -->
                                <div class="space-y-2">
                                    <label class="flex items-center gap-3 text-gray-600 font-medium">
                                        <input type="checkbox" data-target="cctv-comments" class="h-5 w-5 sot-comment-toggle">
                                        <span>CCTV Footage</span>
                                    </label>
                                    <textarea id="cctv-comments" placeholder="CCTV Comments" class="p-2 border rounded-md w-full hidden" rows="2"></textarea>
                                </div>
                                <!-- Case Open -->
                                <div class="space-y-2">
                                    <label class="flex items-center gap-3 text-gray-600 font-medium">
                                        <input type="checkbox" data-target="case-open-comments" class="h-5 w-5 sot-comment-toggle">
                                        <span>Case Open</span>
                                    </label>
                                    <textarea id="case-open-comments" placeholder="Case Open Comments" class="p-2 border rounded-md w-full hidden" rows="2"></textarea>
                                </div>
                                <!-- Technical Assistance -->
                                <div class="space-y-2">
                                    <label class="flex items-center gap-3 text-gray-600 font-medium">
                                        <input type="checkbox" data-target="technical-comments" class="h-5 w-5 sot-comment-toggle">
                                        <span>Technical Assistance</span>
                                    </label>
                                    <textarea id="technical-comments" placeholder="Technical Comments" class="p-2 border rounded-md w-full hidden" rows="2"></textarea>
                                </div>
                                <!-- Sales Assistance -->
                                <div class="space-y-2">
                                    <label class="flex items-center gap-3 text-gray-600 font-medium">
                                        <input type="checkbox" data-target="sales-comments" class="h-5 w-5 sot-comment-toggle">
                                        <span>Sales Assistance</span>
                                    </label>
                                    <textarea id="sales-comments" placeholder="Sales Comments" class="p-2 border rounded-md w-full hidden" rows="2"></textarea>
                                </div>
                                <!-- Response Assistance -->
                                <div class="space-y-2">
                                    <label class="flex items-center gap-3 text-gray-600 font-medium">
                                        <input type="checkbox" data-target="response-comments" class="h-5 w-5 sot-comment-toggle">
                                        <span>Response Assistance</span>
                                    </label>
                                    <textarea id="response-comments" placeholder="Response Comments" class="p-2 border rounded-md w-full hidden" rows="2"></textarea>
                                </div>
                                <!-- Control Room Assistance -->
                                <div class="space-y-2">
                                    <label class="flex items-center gap-3 text-gray-600 font-medium">
                                        <input type="checkbox" data-target="control-room-comments" class="h-5 w-5 sot-comment-toggle">
                                        <span>Control Room Assistance</span>
                                    </label>
                                    <textarea id="control-room-comments" placeholder="Control Room Comments" class="p-2 border rounded-md w-full hidden" rows="2"></textarea>
                                </div>
                                <!-- Complaints/Compliments -->
                                <div class="space-y-2">
                                    <label class="flex items-center gap-3 text-gray-600 font-medium">
                                        <input type="checkbox" data-target="complaints-comments" class="h-5 w-5 sot-comment-toggle">
                                        <span>Complaints/Compliments</span>
                                    </label>
                                    <textarea id="complaints-comments" placeholder="Complaints/Compliments Comments" class="p-2 border rounded-md w-full hidden" rows="2"></textarea>
                                </div>
                                <!-- Risk Assessment -->
                                <div class="space-y-2">
                                    <label class="flex items-center gap-3 text-gray-600 font-medium">
                                        <input type="checkbox" data-target="risk-assessment-comments" class="h-5 w-5 sot-comment-toggle">
                                        <span>Risk Assessment</span>
                                    </label>
                                    <textarea id="risk-assessment-comments" placeholder="Risk Assessment Comments" class="p-2 border rounded-md w-full hidden" rows="2"></textarea>
                                </div>
                            </div>

                            <!-- Save Button -->
                            <div class="flex justify-end pt-4">
                                <button type="button" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save SOT Record</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Manage Users View -->
                <div id="manage-users-view" class="view-panel hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Users</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Add/Edit User Form -->
                        <div class="lg:col-span-1">
                             <div class="border rounded-lg p-6 bg-gray-50">
                                <h3 id="user-form-title" class="text-xl font-semibold mb-4">Add New User</h3>
                                <form id="manage-user-form" class="space-y-4">
                                    <input type="hidden" id="user-id-input">
                                    <div>
                                        <label for="user-name" class="block text-sm font-medium text-gray-700">Name</label>
                                        <input type="text" id="user-name" class="mt-1 p-2 border rounded-md w-full" required>
                                    </div>
                                    <div>
                                        <label for="user-surname" class="block text-sm font-medium text-gray-700">Surname</label>
                                        <input type="text" id="user-surname" class="mt-1 p-2 border rounded-md w-full" required>
                                    </div>
                                    <div>
                                        <label for="user-email" class="block text-sm font-medium text-gray-700">Email</label>
                                        <input type="email" id="user-email" class="mt-1 p-2 border rounded-md w-full" required>
                                    </div>
                                    <div>
                                        <label for="user-department" class="block text-sm font-medium text-gray-700">Department</label>
                                        <select id="user-department" class="mt-1 p-2 border rounded-md w-full" required></select>
                                    </div>
                                    <div>
                                        <label for="user-role" class="block text-sm font-medium text-gray-700">Role</label>
                                        <select id="user-role" class="mt-1 p-2 border rounded-md w-full" required></select>
                                    </div>
                                    <div>
                                        <label for="user-password" class="block text-sm font-medium text-gray-700">Password</label>
                                        <input type="password" id="user-password" class="mt-1 p-2 border rounded-md w-full" required>
                                    </div>
                                    <div class="flex justify-end space-x-3 pt-4">
                                         <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg btn-hover-effect hidden">Cancel</button>
                                        <button type="submit" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save User</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- User List -->
                        <div class="lg:col-span-2">
                            <div class="border rounded-lg p-6 bg-gray-50">
                                <h3 class="text-xl font-semibold mb-4">Existing Users</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white border">
                                        <thead class="bg-gray-200">
                                            <tr>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Name</th>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Email</th>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Department</th>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Role</th>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="users-tbody">
                                            <!-- User rows will be dynamically inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- User Permissions View -->
                <div id="user-permissions-view" class="view-panel hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">User Permissions</h2>
                    <div class="border rounded-lg p-6 bg-gray-50">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                             <div>
                                <label for="permissions-department-select" class="block text-sm font-medium text-gray-700 mb-1">Filter by Department:</label>
                                <select id="permissions-department-select" class="p-2 border rounded-md w-full"></select>
                            </div>
                             <div>
                                <label for="permissions-role-select" class="block text-sm font-medium text-gray-700 mb-1">Filter by Role:</label>
                                <select id="permissions-role-select" class="p-2 border rounded-md w-full"></select>
                            </div>
                            <div>
                                <label for="permissions-user-select" class="block text-sm font-medium text-gray-700 mb-1">Select User:</label>
                                <select id="permissions-user-select" class="p-2 border rounded-md w-full"></select>
                            </div>
                        </div>

                        <div id="permissions-container" class="space-y-4 pt-4 border-t">
                            <!-- Headers -->
                           <div class="grid grid-cols-6 items-center font-semibold text-gray-600 px-4">
                               <div class="col-span-2">Tab</div>
                               <div class="col-span-1 text-center">Access</div>
                               <div class="col-span-1 text-center">Add</div>
                               <div class="col-span-1 text-center">Remove</div>
                               <div class="col-span-1 text-center">Update</div>
                               <div class="col-span-1 text-center">View</div>
                           </div>
                           
                           <!-- Permissions Rows -->
                           <div data-view-name="ob-entry-view" class="permission-row grid grid-cols-6 items-center border-b py-3">
                               <div class="col-span-2 font-semibold text-gray-700">OB Entry</div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="access" class="h-5 w-5 tab-access-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="add" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="remove" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="update" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="view" class="h-5 w-5 action-cb"></div>
                           </div>
                           <div data-view-name="category-edit-view" class="permission-row grid grid-cols-6 items-center border-b py-3">
                               <div class="col-span-2 font-semibold text-gray-700">Category Edit</div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="access" class="h-5 w-5 tab-access-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="add" class="h-5 w-5 action-cb" disabled></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="remove" class="h-5 w-5 action-cb" disabled></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="update" class="h-5 w-5 action-cb" disabled></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="view" class="h-5 w-5 action-cb" disabled></div>
                           </div>
                           <div data-view-name="recoveries-view" class="permission-row grid grid-cols-6 items-center border-b py-3">
                               <div class="col-span-2 font-semibold text-gray-700">Recoveries</div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="access" class="h-5 w-5 tab-access-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="add" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="remove" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="update" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="view" class="h-5 w-5 action-cb"></div>
                           </div>
                           <div data-view-name="complaints-view" class="permission-row grid grid-cols-6 items-center border-b py-3">
                               <div class="col-span-2 font-semibold text-gray-700">Complaints</div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="access" class="h-5 w-5 tab-access-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="add" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="remove" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="update" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="view" class="h-5 w-5 action-cb"></div>
                           </div>
                           <div data-view-name="positive-arrests-view" class="permission-row grid grid-cols-6 items-center border-b py-3">
                               <div class="col-span-2 font-semibold text-gray-700">Positive Arrests</div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="access" class="h-5 w-5 tab-access-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="add" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="remove" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="update" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="view" class="h-5 w-5 action-cb"></div>
                           </div>
                           <div data-view-name="sot-view" class="permission-row grid grid-cols-6 items-center border-b py-3">
                               <div class="col-span-2 font-semibold text-gray-700">SOT Positives</div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="access" class="h-5 w-5 tab-access-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="add" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="remove" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="update" class="h-5 w-5 action-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="view" class="h-5 w-5 action-cb"></div>
                           </div>
                           <div data-view-name="manage-users-view" class="permission-row grid grid-cols-6 items-center border-b py-3">
                               <div class="col-span-2 font-semibold text-gray-700">Manage Users</div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="access" class="h-5 w-5 tab-access-cb"></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="add" class="h-5 w-5 action-cb" disabled></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="remove" class="h-5 w-5 action-cb" disabled></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="update" class="h-5 w-5 action-cb" disabled></div>
                               <div class="col-span-1 text-center"><input type="checkbox" data-action="view" class="h-5 w-5 action-cb" disabled></div>
                           </div>
                       </div>
                         <!-- Save Button -->
                        <div class="flex justify-end pt-6 mt-6 border-t">
                            <button id="save-permissions-btn" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save Permissions</button>
                        </div>
                    </div>
                </div>


            </main>
        </div>
    </div>

    <script>
        // Immediately hide modals to prevent flash on load
        document.getElementById('confirmation-modal').style.display = 'none';
        document.getElementById('success-modal').style.display = 'none';

        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let obCounter = 1;
            let currentRecordAction = 'add';
            let dropdownOptions;
            let users = [];
            let userPermissions = {};
            let currentUser = 'admin'; // 'admin' or a user ID

            const toSentenceCase = (str) => {
                if (typeof str !== 'string' || str.length === 0) return str;
                return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
            };

            const defaultDropdownOptions = {
                obType: ["Abduction", "Accident", "Armed robbery", "Assault", "Business breaking", "Business robbery", "Common robbery", "House breaking", "House robbery", "Theft"],
                policeStation: ["Durban North", "Berea", "Durban Central", "Mayville", "Westville", "Pinetown"],
                followUpUser: [], // Will be populated from users
                area: ["Durban North", "Umhlanga", "La Lucia", "Glenwood", "Morningside"],
                vehicleMake: ["Toyota", "Volkswagen", "Ford", "Hyundai", "BMW", "Mercedes-Benz"],
                ethnicity: ["Asian", "Black", "Coloured", "Indian", "White", "Other"],
                division: ["SOT", "Reaction", "Westmead (sector 1)", "Westmead (sector 2)"],
                recoveryType: ["Vehicle", "Items"],
                incidentType: ["Hijacked", "Stolen", "Missing person", "House breaking"],
                natureOfCrime: ["Armed robbery", "House breaking", "Theft of motor vehicle", "Common robbery", "Assault"],
                sotPersonAssigned: ["Jono", "Jaco", "Michael", "Zandre", "Derek"],
                department: ["SOT", "Reaction", "Control Room", "Sales", "Marketing", "I.T", "Customer Care"],
                role: ["SOT Manager", "SOT Member", "Reaction Manager", "Reaction Officer", "Control Room Operator", "Sales Field", "I.T", "Customer Care"]
            };
            
            // --- ELEMENT REFERENCES ---
            const sidebarNav = document.getElementById('sidebar-nav');
            const viewPanels = document.querySelectorAll('.view-panel');
            const loginAsSelect = document.getElementById('login-as-select');
            
            const userForm = document.getElementById('manage-user-form');
            const userFormTitle = document.getElementById('user-form-title');
            const userIdInput = document.getElementById('user-id-input');
            const userNameInput = document.getElementById('user-name');
            const userSurnameInput = document.getElementById('user-surname');
            const userEmailInput = document.getElementById('user-email');
            const userDepartmentSelect = document.getElementById('user-department');
            const userRoleSelect = document.getElementById('user-role');
            const userPasswordInput = document.getElementById('user-password');
            const usersTbody = document.getElementById('users-tbody');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            
            const permissionsDeptSelect = document.getElementById('permissions-department-select');
            const permissionsRoleSelect = document.getElementById('permissions-role-select');
            const permissionsUserSelect = document.getElementById('permissions-user-select');
            const permissionsContainer = document.getElementById('permissions-container');
            const savePermissionsBtn = document.getElementById('save-permissions-btn');

            // Modals
            const confirmModal = document.getElementById('confirmation-modal');
            const confirmModalMessage = document.getElementById('confirm-modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const successModal = document.getElementById('success-modal');
            const successModalTitle = document.getElementById('success-modal-title');
            const successModalMessage = document.getElementById('success-modal-message');
            const successModalOkBtn = document.getElementById('success-modal-ok-btn');

            // --- FUNCTIONS ---

            const showConfirmationModal = (message, onConfirmCallback) => {
                confirmModalMessage.textContent = message;
                confirmModal.style.display = 'flex';
                const newConfirmBtn = modalConfirmBtn.cloneNode(true);
                modalConfirmBtn.parentNode.replaceChild(newConfirmBtn, modalConfirmBtn);
                newConfirmBtn.addEventListener('click', () => {
                    confirmModal.style.display = 'none';
                    onConfirmCallback();
                });
            };
            
            modalCancelBtn.addEventListener('click', () => confirmModal.style.display = 'none');

            const showSuccessModal = (title, message) => {
                successModalTitle.textContent = title;
                successModalMessage.textContent = message;
                successModal.style.display = 'flex';
            };

            successModalOkBtn.addEventListener('click', () => successModal.style.display = 'none');

            const saveData = () => {
                localStorage.setItem('dropdownData', JSON.stringify(dropdownOptions));
                localStorage.setItem('usersData', JSON.stringify(users));
                localStorage.setItem('userPermissionsData', JSON.stringify(userPermissions));
            };
            
            const loadData = () => {
                const savedDropdowns = localStorage.getItem('dropdownData');
                dropdownOptions = savedDropdowns ? JSON.parse(savedDropdowns) : JSON.parse(JSON.stringify(defaultDropdownOptions));
                const savedUsers = localStorage.getItem('usersData');
                users = savedUsers ? JSON.parse(savedUsers) : [];
                const savedPermissions = localStorage.getItem('userPermissionsData');
                userPermissions = savedPermissions ? JSON.parse(savedPermissions) : {};
            };

            const renderCategoryEditor = (categoryKey) => {
                const categoryData = dropdownOptions[categoryKey] || [];
                const categorySelector = document.getElementById('category-selector');
                const editingCategoryName = document.getElementById('editing-category-name');
                const categoryItemList = document.getElementById('category-item-list');
                
                if (editingCategoryName) {
                    editingCategoryName.textContent = `Editing: ${categorySelector.options[categorySelector.selectedIndex].text}`;
                }
                
                if (categoryItemList) {
                    categoryItemList.innerHTML = '';
                    categoryData.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex justify-between items-center p-2 bg-white rounded-md shadow-sm';
                        itemDiv.innerHTML = `
                            <span class="flex-grow">${item}</span>
                            <button data-item="${item}" data-index="${index}" class="delete-item-btn text-red-500 hover:text-red-700 font-bold p-1">X</button>
                        `;
                        categoryItemList.appendChild(itemDiv);
                    });
                }
            };
            
            const applyPermissions = () => {
                const activeViewButton = sidebarNav.querySelector('.active-btn');
                let activeViewId = activeViewButton ? activeViewButton.dataset.view : 'ob-entry-view';

                sidebarNav.querySelectorAll('button[data-view]').forEach(btn => {
                    const view = btn.dataset.view;
                    const hasAccess = currentUser === 'admin' || (userPermissions[currentUser] && userPermissions[currentUser].tabs[view] && userPermissions[currentUser].tabs[view].access);
                    
                    btn.classList.toggle('hidden', !hasAccess);

                    if (!hasAccess && activeViewId === view) {
                        const firstVisibleButton = sidebarNav.querySelector('button[data-view]:not(.hidden)');
                        activeViewId = firstVisibleButton ? firstVisibleButton.dataset.view : null;
                    }
                });
                
                if (!activeViewId) {
                    viewPanels.forEach(panel => panel.classList.add('hidden'));
                     sidebarNav.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('active-btn', 'bg-blue-500', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    return;
                }

                const newActiveButton = sidebarNav.querySelector(`button[data-view="${activeViewId}"]`);
                sidebarNav.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('active-btn', 'bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });

                if (newActiveButton) {
                    newActiveButton.classList.add('active-btn', 'bg-blue-500', 'text-white');
                    newActiveButton.classList.remove('bg-gray-200', 'text-gray-700');
                }
                showView(activeViewId);
            };

            const applyActionPermissions = (viewId) => {
                const viewPanel = document.getElementById(viewId);
                if (!viewPanel) return;

                const actionsContainer = viewPanel.querySelector('.flex.justify-center.space-x-4.mb-6');
                if (!actionsContainer) return;

                const permissions = (currentUser !== 'admin' && userPermissions[currentUser]) ? userPermissions[currentUser].tabs[viewId] : { add: true, remove: true, update: true, view: true };

                actionsContainer.querySelectorAll('.ob-action-btn').forEach(btn => {
                    const action = btn.dataset.action;
                    btn.style.display = (permissions && permissions[action]) ? '' : 'none';
                });
            };
            
            const showView = (viewId) => {
                viewPanels.forEach(panel => {
                    panel.classList.toggle('hidden', panel.id !== viewId);
                });
                applyActionPermissions(viewId);
            };

            const populateDropdown = (select, options, placeholder) => {
                if (!select) return;
                select.innerHTML = '';
                if (placeholder) {
                    select.innerHTML += `<option value="">${placeholder}</option>`;
                }
                options.forEach(opt => {
                    const value = typeof opt === 'object' ? opt.id : opt;
                    const text = typeof opt === 'object' ? `${opt.name} ${opt.surname}` : opt;
                    select.innerHTML += `<option value="${value}">${text}</option>`;
                });
            };

            const updateAllDropdowns = () => {
                populateDropdown(document.getElementById('ob-type-select'), dropdownOptions.obType, 'No OB Type Selected');
                populateDropdown(document.getElementById('police-station-select'), dropdownOptions.policeStation, 'No Police Station Selected');
                populateDropdown(document.getElementById('follow-up-user-select'), users, 'No User Selected');
                populateDropdown(document.getElementById('area-select'), dropdownOptions.area, 'No Area Selected');
                populateDropdown(document.getElementById('recovery-vehicle-brand-select'), dropdownOptions.vehicleMake, 'No Vehicle Brand Selected');
                populateDropdown(document.getElementById('recovery-ps-from-select'), dropdownOptions.policeStation, 'No Police Station Selected');
                populateDropdown(document.getElementById('recovery-ps-recovered-select'), dropdownOptions.policeStation, 'No Police Station Selected');
                populateDropdown(document.getElementById('recovery-division-select'), dropdownOptions.division, 'No Division Selected');
                populateDropdown(document.getElementById('recovery-type-select'), dropdownOptions.recoveryType, 'No Recovery Type Selected');
                populateDropdown(document.getElementById('recovery-incident-type-select'), dropdownOptions.incidentType, 'No Incident Type Selected');
                populateDropdown(document.getElementById('pa-division-select'), dropdownOptions.division, 'No Division Selected');
                document.querySelectorAll('.pa-nature-crime-select').forEach(s => populateDropdown(s, dropdownOptions.natureOfCrime, 'No Crime Selected'));
                document.querySelectorAll('.pa-police-station-select').forEach(s => populateDropdown(s, dropdownOptions.policeStation, 'No Police Station Selected'));
                populateDropdown(document.getElementById('sot-incident-type-select'), dropdownOptions.natureOfCrime, 'No Incident Type Selected');
                populateDropdown(document.getElementById('sot-person-assigned-select'), dropdownOptions.sotPersonAssigned, 'No User Assigned');
                populateDropdown(userDepartmentSelect, dropdownOptions.department, 'Select Department');
                populateDropdown(userRoleSelect, dropdownOptions.role, 'Select Role');
                populateDropdown(permissionsDeptSelect, dropdownOptions.department, 'All Departments');
                populateDropdown(permissionsRoleSelect, dropdownOptions.role, 'All Roles');
                filterPermissionUsers();
            };

            const renderUsersTable = () => {
                usersTbody.innerHTML = '';
                users.forEach(user => {
                    usersTbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-4 border-b">${user.name} ${user.surname}</td>
                            <td class="py-2 px-4 border-b">${user.email}</td>
                            <td class="py-2 px-4 border-b">${user.department}</td>
                            <td class="py-2 px-4 border-b">${user.role}</td>
                            <td class="py-2 px-4 border-b space-x-2">
                                <button data-id="${user.id}" class="edit-user-btn text-blue-500 hover:underline">Edit</button>
                                <button data-id="${user.id}" class="delete-user-btn text-red-500 hover:underline">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            };

            const resetUserForm = () => {
                userForm.reset();
                userIdInput.value = '';
                userFormTitle.textContent = 'Add New User';
                cancelEditBtn.classList.add('hidden');
            };

            const handleUserFormSubmit = (e) => {
                e.preventDefault();
                const userId = userIdInput.value;
                const user = {
                    id: userId ? parseInt(userId) : Date.now(),
                    name: userNameInput.value,
                    surname: userSurnameInput.value,
                    email: userEmailInput.value,
                    department: userDepartmentSelect.value,
                    role: userRoleSelect.value,
                    password: userPasswordInput.value
                };
                showConfirmationModal(`Are you sure you want to ${userId ? 'update' : 'add'} this user?`, () => {
                    if (userId) {
                        const index = users.findIndex(u => u.id == userId);
                        users[index] = user;
                    } else {
                        users.push(user);
                        initializePermissionsForUser(user.id);
                    }
                    saveData();
                    renderUsersTable();
                    updateAllDropdowns();
                    populateLoginDropdown();
                    resetUserForm();
                    showSuccessModal('Success', `User has been successfully ${userId ? 'updated' : 'saved'}.`);
                });
            };
            
            const handleUsersTableClick = (e) => {
                if (e.target.classList.contains('edit-user-btn')) {
                    const userId = e.target.dataset.id;
                    const user = users.find(u => u.id == userId);
                    if (user) {
                        userFormTitle.textContent = 'Edit User';
                        userIdInput.value = user.id;
                        userNameInput.value = user.name;
                        userSurnameInput.value = user.surname;
                        userEmailInput.value = user.email;
                        userDepartmentSelect.value = user.department;
                        userRoleSelect.value = user.role;
                        userPasswordInput.value = user.password;
                        cancelEditBtn.classList.remove('hidden');
                    }
                } else if (e.target.classList.contains('delete-user-btn')) {
                    const userId = e.target.dataset.id;
                    const user = users.find(u => u.id == userId);
                    showConfirmationModal(`Are you sure you want to delete user ${user.name} ${user.surname}?`, () => {
                        users = users.filter(u => u.id != userId);
                        delete userPermissions[userId];
                        saveData();
                        renderUsersTable();
                        updateAllDropdowns();
                        populateLoginDropdown();
                        showSuccessModal('Success', 'User has been deleted.');
                    });
                }
            };
            
            const initializePermissionsForUser = (userId) => {
                if (!userPermissions[userId]) {
                    userPermissions[userId] = { tabs: {} };
                    document.querySelectorAll('.permission-row').forEach(row => {
                        const view = row.dataset.viewName;
                        userPermissions[userId].tabs[view] = { access: true, add: true, remove: true, update: true, view: true };
                    });
                }
            };

            const renderPermissions = (userId) => {
                const permissions = userPermissions[userId];
                document.querySelectorAll('.permission-row').forEach(row => {
                    const view = row.dataset.viewName;
                    const tabPerms = (permissions && permissions.tabs && permissions.tabs[view]) ? permissions.tabs[view] : {};
                    const accessCheckbox = row.querySelector('[data-action="access"]');
                    accessCheckbox.checked = tabPerms.access || false;
                    row.querySelectorAll('.action-cb').forEach(cb => {
                        const action = cb.dataset.action;
                        cb.checked = tabPerms[action] || false;
                        cb.disabled = !accessCheckbox.checked || cb.hasAttribute('disabled');
                    });
                });
            };

            const savePermissions = () => {
                const selectedUserId = permissionsUserSelect.value;
                if (!selectedUserId) return showSuccessModal('Error', 'Please select a user first.');
                showConfirmationModal('Are you sure you want to save these permissions?', () => {
                    const userPerms = userPermissions[selectedUserId] || { tabs: {} };
                    document.querySelectorAll('.permission-row').forEach(row => {
                        const view = row.dataset.viewName;
                        if (!userPerms.tabs[view]) userPerms.tabs[view] = {};
                        userPerms.tabs[view].access = row.querySelector('[data-action="access"]').checked;
                        row.querySelectorAll('.action-cb').forEach(cb => {
                            userPerms.tabs[view][cb.dataset.action] = cb.checked;
                        });
                    });
                    userPermissions[selectedUserId] = userPerms;
                    saveData();
                    showSuccessModal('Success', 'Permissions updated.');
                    if (currentUser === selectedUserId) {
                        applyPermissions();
                    }
                });
            };

            const filterPermissionUsers = () => {
                const dept = permissionsDeptSelect.value;
                const role = permissionsRoleSelect.value;
                let filtered = users.filter(u => (!dept || u.department === dept) && (!role || u.role === role));
                populateDropdown(permissionsUserSelect, filtered, 'Select User');
                renderPermissions(null);
            };

            const populateLoginDropdown = () => {
                loginAsSelect.innerHTML = '<option value="admin">Admin</option>';
                users.forEach(user => {
                    loginAsSelect.innerHTML += `<option value="${user.id}">${user.name} ${user.surname}</option>`;
                });
                loginAsSelect.value = currentUser;
            };

            const handleAddItem = () => {
                const categorySelector = document.getElementById('category-selector');
                const newItemInput = document.getElementById('new-item-input');
                const selectedCategory = categorySelector.value;
                const newItem = newItemInput.value.trim();
                if (newItem && !dropdownOptions[selectedCategory].includes(newItem)) {
                    showConfirmationModal(`Are you sure you want to add "${newItem}"?`, () => {
                        dropdownOptions[selectedCategory].push(toSentenceCase(newItem));
                        saveData();
                        renderCategoryEditor(selectedCategory);
                        updateAllDropdowns();
                        newItemInput.value = '';
                        showSuccessModal('Success', `Successfully added "${newItem}".`);
                    });
                } else if (newItem) {
                    showSuccessModal('Error', `Item "${newItem}" already exists in this category.`);
                }
            };

            const handleDeleteItem = (event) => {
                const deleteButton = event.target.closest('.delete-item-btn');
                const categorySelector = document.getElementById('category-selector');
                if (deleteButton) {
                    const selectedCategory = categorySelector.value;
                    const itemIndex = parseInt(deleteButton.dataset.index, 10);
                    const itemToDelete = deleteButton.dataset.item;
                    showConfirmationModal(`Are you sure you want to delete "${itemToDelete}"?`, () => {
                        dropdownOptions[selectedCategory].splice(itemIndex, 1);
                        saveData();
                        renderCategoryEditor(selectedCategory);
                        updateAllDropdowns();
                        showSuccessModal('Success', `Successfully deleted "${itemToDelete}".`);
                    });
                }
            };


            // --- EVENT LISTENERS ---
            loginAsSelect.addEventListener('change', (e) => {
                currentUser = e.target.value;
                applyPermissions();
            });

            sidebarNav.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-view]');
                if (btn && !btn.classList.contains('hidden')) {
                    sidebarNav.querySelectorAll('button').forEach(b => {
                        b.classList.remove('active-btn', 'bg-blue-500', 'text-white');
                        b.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    btn.classList.add('active-btn', 'bg-blue-500', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    showView(btn.dataset.view);
                }
            });
            
            userForm.addEventListener('submit', handleUserFormSubmit);
            usersTbody.addEventListener('click', handleUsersTableClick);
            cancelEditBtn.addEventListener('click', resetUserForm);

            permissionsDeptSelect.addEventListener('change', filterPermissionUsers);
            permissionsRoleSelect.addEventListener('change', filterPermissionUsers);
            permissionsUserSelect.addEventListener('change', e => renderPermissions(e.target.value));
            savePermissionsBtn.addEventListener('click', savePermissions);

            if (permissionsContainer) {
                permissionsContainer.addEventListener('change', (e) => {
                    if (e.target.classList.contains('tab-access-cb')) {
                        const row = e.target.closest('.permission-row');
                        row.querySelectorAll('.action-cb:not([disabled])').forEach(cb => {
                            cb.disabled = !e.target.checked;
                            if (!e.target.checked) cb.checked = false;
                        });
                    }
                });
            }

            // --- INITIALIZATION ---
            const initializeApp = () => {
                loadData();
                users.forEach(user => initializePermissionsForUser(user.id));
                populateLoginDropdown();
                
                // Populate all SAPS 13 number fields
                const sapContainers = document.querySelectorAll('.sap-container');
                sapContainers.forEach(container => {
                    const monthSelect = container.querySelector('.sap-month');
                    const yearSelect = container.querySelector('.sap-year');
                    
                    const populateSapDropdowns = (monthSelect, yearSelect) => {
                        if (!monthSelect || !yearSelect) return;
                        const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                        monthSelect.innerHTML = '';
                        months.forEach(month => {
                            const option = document.createElement('option');
                            option.value = month;
                            option.textContent = month;
                            monthSelect.appendChild(option);
                        });
                        const currentYear = new Date().getFullYear();
                        yearSelect.innerHTML = '';
                        for (let i = 0; i < 10; i++) {
                            const year = currentYear + i;
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            yearSelect.appendChild(option);
                        }
                    };
                    populateSapDropdowns(monthSelect, yearSelect);
                });

                updateAllDropdowns();
                applyPermissions(); // Apply permissions on load
                document.getElementById('created-date').textContent = new Date().toLocaleString();
                
                const categorySelectorElem = document.getElementById('category-selector');
                if (categorySelectorElem) {
                    renderCategoryEditor(categorySelectorElem.value);
                    categorySelectorElem.addEventListener('change', () => renderCategoryEditor(categorySelectorElem.value));
                }
                const addItemBtn = document.getElementById('add-item-btn');
                if(addItemBtn) addItemBtn.addEventListener('click', handleAddItem);
                const newItemInput = document.getElementById('new-item-input');
                if(newItemInput) newItemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddItem(); });
                const categoryItemList = document.getElementById('category-item-list');
                if(categoryItemList) categoryItemList.addEventListener('click', handleDeleteItem);

            };

            initializeApp();
        });
    </script>
</body>
</html>

