<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Management UI</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the page */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple animation for button hover */
        .btn-hover-effect {
            transition: all 0.2s ease-in-out;
        }
        .btn-hover-effect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .active-btn {
            background-color: #3B82F6; /* blue-500 */
            color: white;
        }
        .action-btn-active {
            background-color: #2563EB; /* blue-600 */
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-btn-active {
            background-color: #10B981; /* green-500 */
            color: white;
        }
        /* Custom scrollbar for category list */
        .category-list::-webkit-scrollbar {
            width: 8px;
        }
        .category-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .category-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .category-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Styles for modals */
        .modal-hidden {
            display: none;
        }
        .autosize-textarea {
            resize: none;
            overflow-y: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Action</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirm-modal-message" class="text-sm text-gray-500"></p>
                </div>
                <div id="modal-buttons" class="items-center px-4 py-3">
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Confirm
                    </button>
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Notification Modal -->
    <div id="success-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="success-modal-title" class="text-lg leading-6 font-medium text-gray-900">Success</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="success-modal-message" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="success-modal-ok-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full bg-gray-800 p-2 text-white flex justify-end items-center">
        <label for="login-as-select" class="text-sm mr-2">Currently logged in as:</label>
        <select id="login-as-select" class="bg-gray-700 text-white p-1 rounded-md text-sm"></select>
    </div>


    <div class="container mx-auto p-4 md:p-8">
        <div class="flex flex-col md:flex-row bg-white rounded-xl shadow-lg min-h-[80vh]">
            
            <!-- Sidebar Navigation -->
            <aside class="w-full md:w-64 p-6 border-b md:border-b-0 md:border-r border-gray-200">
                <nav id="sidebar-nav" class="space-y-4">
                    <!-- Navigation Button: OB Entry -->
                    <button id="ob-entry-btn" data-view="ob-entry-view" class="w-full flex items-center justify-between p-3 rounded-lg bg-gray-200 text-gray-700 font-semibold shadow-md btn-hover-effect">
                        <span>OB Entry</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                    <!-- Navigation Button: Category Edit -->
                    <button data-view="category-edit-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Category Edit</button>
                    
                    <!-- Other Navigation Buttons -->
                    <button data-view="recoveries-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Recoveries</button>
                    <button data-view="complaints-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Complaints</button>
                    <button data-view="positive-arrests-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Positive Arrests</button>
                    <button data-view="sot-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">SOT Positives</button>
                    <button data-view="department-roles-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Departments & Roles</button>
                    <button data-view="manage-users-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">Manage Users</button>
                    <button data-view="user-permissions-view" class="w-full text-left p-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">User Permissions</button>
                </nav>
            </aside>

            <!-- Main Content Area -->
            <main id="main-content" class="flex-1 p-6 md:p-10 overflow-auto">
                <!-- OB Entry View (Now visible by default) -->
                <div id="ob-entry-view" class="view-panel">
                    <div id="ob-actions" class="flex justify-center space-x-4 mb-6">
                        <button data-action="add" class="ob-action-btn px-6 py-2 rounded-lg bg-blue-500 text-white font-semibold shadow-md btn-hover-effect action-btn-active">Add Record</button>
                        <button data-action="view" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">View Records</button>
                    </div>

                    <!-- OB Entry Form Panel -->
                    <div id="ob-entry-form-panel">
                        <div class="border rounded-lg p-6 bg-gray-50">
                            <div class="flex justify-between items-center border-b pb-4 mb-6">
                                <h2 id="ob-form-title" class="text-xl font-bold text-gray-800">Occurrence Book</h2>
                                <span class="text-sm font-medium text-gray-600">UID:</span>
                            </div>
                            
                            <form id="ob-form" class="space-y-4">
                                <input type="hidden" id="ob-record-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">OB Number:</label>
                                        <span id="ob-number-display" class="font-bold text-gray-800"></span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Created:</label>
                                        <span id="created-date" class="text-gray-800"></span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1">
                                    <div class="flex items-center">
                                        <label class="w-48 text-gray-600 font-medium">Time of Incident:</label>
                                        <span class="mr-2">From</span>
                                        <input type="datetime-local" id="ob-time-from" class="p-2 border rounded-md w-full">
                                        <span class="mx-2">To</span>
                                        <input type="datetime-local" id="ob-time-to" class="p-2 border rounded-md w-full">
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Created By:</label>
                                        <span id="created-by-user" class="text-gray-800"></span>
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">OB Type<span class="text-red-500">*</span>:</label>
                                        <select id="ob-type-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">OB Category:</label>
                                        <input type="text" id="ob-category" class="p-2 border rounded-md w-2/3">
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Police Station:</label>
                                        <select id="police-station-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">CAS Number:</label>
                                        <input type="text" id="ob-cas-number" class="p-2 border rounded-md w-2/3">
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">SAP 13 Number:</label>
                                        <div class="w-2/3 sap-container">
                                            <input type="text" class="p-2 border rounded-md numeric-only w-full mb-2" placeholder="Number">
                                            <div class="flex items-center space-x-2">
                                                <select class="p-2 border rounded-md sap-month"></select>
                                                <span class="text-gray-500">/</span>
                                                <select class="p-2 border rounded-md sap-year"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Requires Followup:</label>
                                        <input type="checkbox" id="ob-requires-followup" class="h-5 w-5">
                                    </div>
                                </div>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Follow up User:</label>
                                        <select id="follow-up-user-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                </div>
                                
                                <!-- Location Information Section -->
                                <div id="ob-location-info-section" class="border-t pt-6 mt-6">
                                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Location Information</h3>
                                    <div class="space-y-4">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div class="flex items-center">
                                                <label class="w-1/3 text-gray-600 font-medium">Area:</label>
                                                <div class="flex w-2/3">
                                                    <select id="area-select" class="p-2 border rounded-md w-full"></select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div class="flex items-center">
                                                <label class="w-1/3 text-gray-600 font-medium">Client:</label>
                                                <div class="flex items-center w-2/3">
                                                    <span class="text-gray-800 mr-4">Recorded as Non-Client</span>
                                                    <button type="button" class="px-4 py-2 bg-blue-500 text-white rounded-md btn-hover-effect">Lookup</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                            <div class="flex items-center">
                                                <label class="w-1/3 text-gray-600 font-medium">Client Account:</label>
                                                <input type="text" id="ob-client-account" class="p-2 border rounded-md w-2/3">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                            <div class="flex items-center">
                                                <label class="w-1/3 text-gray-600 font-medium">Contact No:</label>
                                                <input type="text" id="ob-contact-no" class="p-2 border rounded-md w-2/3 numeric-only">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 gap-6 bg-blue-50 p-4 rounded-md">
                                             <div class="flex">
                                                <label class="w-1/6 text-gray-600 font-medium">Address:</label>
                                                <div class="w-5/6 space-y-2">
                                                    <input type="text" id="ob-address1" class="p-2 border rounded-md w-full">
                                                    <input type="text" id="ob-address2" class="p-2 border rounded-md w-full">
                                                    <input type="text" id="ob-address3" class="p-2 border rounded-md w-full">
                                                </div>
                                            </div>
                                        </div>
                                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-4 rounded-md">
                                            <div class="flex items-center">
                                                <label class="w-1/3 text-gray-600 font-medium">Latitude:</label>
                                                <input type="text" id="ob-lat" class="p-2 border rounded-md w-2/3 decimal-only">
                                            </div>
                                             <div class="flex items-center">
                                                <label class="w-1/3 text-gray-600 font-medium">Longitude:</label>
                                                <input type="text" id="ob-lon" class="p-2 border rounded-md w-2/3 decimal-only">
                                            </div>
                                        </div>
                                         <div class="grid grid-cols-1 gap-6">
                                             <div class="flex">
                                                <label class="w-1/6 text-gray-600 font-medium">Comments:</label>
                                                <textarea id="ob-comments" class="p-2 border rounded-md w-5/6 h-24 autosize-textarea"></textarea>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div class="flex items-center">
                                                <label class="w-1/3 text-gray-600 font-medium">Status:</label>
                                                <div id="status-buttons" class="flex space-x-2">
                                                    <button type="button" data-status="Open" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700 status-btn-active">Open</button>
                                                    <button type="button" data-status="Closed" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700">Closed</button>
                                                    <button type="button" data-status="Pending" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700">Pending</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Save Button -->
                                <div class="flex justify-end pt-4">
                                    <button type="button" id="save-record-btn" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save Record</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- OB View Records Panel -->
                    <div id="ob-view-records-panel" class="hidden">
                        <div class="border rounded-lg p-6 bg-gray-50">
                            <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">View Occurrence Book Records</h2>
                            <form id="ob-search-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                                <div class="flex items-center gap-2 md:col-span-2 lg:col-span-3">
                                    <label for="ob-search-date-from" class="text-sm font-medium text-gray-700 whitespace-nowrap">Date From:</label>
                                    <input type="date" id="ob-search-date-from" class="p-2 border rounded-md w-full">
                                    <label for="ob-search-date-to" class="text-sm font-medium text-gray-700 ml-2 whitespace-nowrap">To:</label>
                                    <input type="date" id="ob-search-date-to" class="p-2 border rounded-md w-full">
                                </div>
                                <select id="ob-search-type" class="p-2 border rounded-md"></select>
                                <select id="ob-search-station" class="p-2 border rounded-md"></select>
                                <input type="text" id="ob-search-cas" class="p-2 border rounded-md" placeholder="Search by CAS Number">
                                <input type="text" id="ob-search-sap" class="p-2 border rounded-md" placeholder="Search by SAP 13 Number">
                                <select id="ob-search-area" class="p-2 border rounded-md"></select>
                                <input type="text" id="ob-search-client" class="p-2 border rounded-md" placeholder="Search by Client Account">
                                <input type="text" id="ob-search-contact" class="p-2 border rounded-md" placeholder="Search by Contact No">
                                <input type="text" id="ob-search-address" class="p-2 border rounded-md lg:col-span-1" placeholder="Search by Address">
                                <div class="flex items-center gap-2 lg:col-span-2">
                                    <button type="button" id="ob-search-btn" class="w-full px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md btn-hover-effect">Search</button>
                                    <button type="button" id="ob-clear-search-btn" class="w-full px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md btn-hover-effect">Clear</button>
                                </div>
                            </form>

                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">OB Num</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Date</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Time of Incident</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">OB Type</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Client Account</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Address</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Area</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Comments</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Status</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ob-records-tbody">
                                        <!-- OB Record rows will be dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Category Edit View -->
                <div id="category-edit-view" class="view-panel hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Category Editor</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label for="category-selector" class="block text-sm font-medium text-gray-700 mb-2">Select a category to edit:</label>
                            <select id="category-selector" class="w-full p-2 border rounded-md">
                                <!-- Options will be dynamically populated by JavaScript -->
                            </select>
                        </div>
                        <div id="editor-panel">
                            <h3 id="editing-category-name" class="text-xl font-semibold mb-4"></h3>
                            <div class="bg-gray-50 border rounded-lg p-4">
                                <div class="mb-4">
                                    <label for="new-item-input" class="block text-sm font-medium text-gray-700">Add new item:</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="text" id="new-item-input" class="flex-1 block w-full rounded-none rounded-l-md p-2 border-gray-300" placeholder="New category item">
                                        <button id="add-item-btn" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 hover:bg-gray-100">Add</button>
                                    </div>
                                </div>
                                <div id="category-item-list" class="category-list max-h-80 overflow-y-auto space-y-2">
                                    <!-- Items will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recoveries View -->
                <div id="recoveries-view" class="view-panel hidden">
                    <div id="recoveries-actions" class="flex justify-center space-x-4 mb-6">
                        <button data-action="add" class="ob-action-btn px-6 py-2 rounded-lg bg-blue-500 text-white font-semibold shadow-md btn-hover-effect action-btn-active">Add Record</button>
                        <button data-action="view" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">View Records</button>
                    </div>
                    <div id="recoveries-form-panel">
                        <div class="border rounded-lg p-6 bg-gray-50">
                            <h2 id="recovery-form-title" class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">Recoveries</h2>
                            <form id="recoveries-form" class="space-y-4">
                                <input type="hidden" id="recovery-record-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Date and Time:</label>
                                        <input type="datetime-local" id="recovery-datetime" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Name:</label>
                                        <input type="text" id="recovery-name" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Division:</label>
                                        <select id="recovery-division-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Recovery Type:</label>
                                        <select id="recovery-type-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Incident Type:</label>
                                        <select id="recovery-incident-type-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Duration of Incident:</label>
                                        <input type="text" id="recovery-duration" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Registration:</label>
                                        <input type="text" id="recovery-registration" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Vin Number:</label>
                                        <input type="text" id="recovery-vin" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Items Recovered:</label>
                                        <input type="text" id="recovery-items" class="p-2 border rounded-md w-2/3">
                                    </div>
                                     <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Quantity of items:</label>
                                        <input type="text" id="recovery-quantity" class="p-2 border rounded-md w-2/3 numeric-only">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Vehicle Brand:</label>
                                        <select id="recovery-vehicle-brand-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Make of vehicle:</label>
                                         <input type="text" id="recovery-make" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Police Station (From):</label>
                                        <select id="recovery-ps-from-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Case number:</label>
                                        <input type="text" id="recovery-case-number" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Police Station (Recovered):</label>
                                        <select id="recovery-ps-recovered-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">SAPS 13 Number:</label>
                                        <div class="w-2/3 sap-container">
                                            <input type="text" class="p-2 border rounded-md numeric-only w-full mb-2" placeholder="Number">
                                            <div class="flex items-center space-x-2">
                                                <select class="p-2 border rounded-md sap-month"></select>
                                                <span class="text-gray-500">/</span>
                                                <select class="p-2 border rounded-md sap-year"></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Estimated Value of vehicle:</label>
                                        <input type="text" id="recovery-value-vehicle" class="p-2 border rounded-md w-2/3 currency-rand">
                                    </div>
                                     <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Estimated Value of Items:</label>
                                        <input type="text" id="recovery-value-items" class="p-2 border rounded-md w-2/3 currency-rand">
                                    </div>
                                     <div class="flex items-center col-span-1 md:col-span-2">
                                        <label class="w-1/6 text-gray-600 font-medium">Address Of Incident:</label>
                                        <textarea id="recovery-address" class="p-2 border rounded-md w-5/6 h-20 autosize-textarea"></textarea>
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Coordinates (Recovery):</label>
                                        <div class="flex w-2/3 gap-2">
                                            <input type="text" id="recovery-lat" placeholder="Latitude" class="p-2 border rounded-md w-1/2 decimal-only">
                                            <input type="text" id="recovery-lon" placeholder="Longitude" class="p-2 border rounded-md w-1/2 decimal-only">
                                        </div>
                                    </div>
                                     <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Marshall OB number:</label>
                                        <input type="text" id="recovery-ob-number" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Recovered by:</label>
                                        <input type="text" id="recovery-recovered-by" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Photo of Vehicle Stolen:</label>
                                        <input type="file" id="recovery-photo-vehicle" class="p-1 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Photo of Items Stolen:</label>
                                        <input type="file" id="recovery-photo-items" class="p-1 border rounded-md w-2/3">
                                    </div>
                                </div>
                                 <div class="flex justify-end pt-4">
                                    <button type="button" id="save-recovery-btn" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save Recovery</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div id="recoveries-view-records-panel" class="hidden">
                        <div class="border rounded-lg p-6 bg-gray-50">
                             <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">View Recovery Records</h2>
                             <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Date</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Name</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Division</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Type</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recoveries-records-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Complaints View -->
                <div id="complaints-view" class="view-panel hidden">
                    <div id="complaints-actions" class="flex justify-center space-x-4 mb-6">
                        <button data-action="add" class="ob-action-btn px-6 py-2 rounded-lg bg-blue-500 text-white font-semibold shadow-md btn-hover-effect action-btn-active">Add Record</button>
                        <button data-action="view" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">View Records</button>
                    </div>
                    <div id="complaints-form-panel">
                        <div class="border rounded-lg p-6 bg-gray-50">
                            <h2 id="complaint-form-title" class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">Complaints</h2>
                            <form id="complaints-form" class="space-y-4">
                                <input type="hidden" id="complaint-record-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Complaint Ref Number:</label>
                                        <span id="complaint-ref-number" class="font-bold text-gray-800"></span>
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Date of Complaint:</label>
                                        <input type="datetime-local" id="complaint-date" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Complainant Name:</label>
                                        <input type="text" id="complaint-name" placeholder="Full Name" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Contact Number:</label>
                                        <input type="text" id="complaint-contact" placeholder="Phone Number" class="p-2 border rounded-md w-2/3 numeric-only">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Email Address:</label>
                                        <input type="email" id="complaint-email" placeholder="Email" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Complaint Against (Dept):</label>
                                        <select id="complaint-department-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Complaint Against (User):</label>
                                        <select id="complaint-user-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                    <div class="flex items-center col-span-1 md:col-span-2">
                                        <label class="w-1/6 text-gray-600 font-medium">Nature of Complaint:</label>
                                        <select id="complaint-nature-select" class="p-2 border rounded-md w-5/6"></select>
                                    </div>
                                    <div class="flex items-start col-span-1 md:col-span-2">
                                        <label class="w-1/6 text-gray-600 font-medium pt-2">Details:</label>
                                        <textarea id="complaint-details" placeholder="Please provide a detailed description of the complaint..." class="p-2 border rounded-md w-5/6 autosize-textarea" rows="4"></textarea>
                                    </div>
                                     <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Assigned To:</label>
                                        <select id="complaint-assigned-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Status:</label>
                                        <div id="complaint-status-buttons" class="flex space-x-2">
                                            <button type="button" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700 status-btn-active" data-status="Open">Open</button>
                                            <button type="button" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700" data-status="Pending">Pending</button>
                                            <button type="button" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700" data-status="Resolved">Resolved</button>
                                        </div>
                                    </div>
                                    <div id="complaint-resolution-container" class="items-start col-span-1 md:col-span-2 hidden">
                                         <label class="w-1/6 text-gray-600 font-medium pt-2">Resolution:</label>
                                         <textarea id="complaint-resolution" placeholder="Describe the resolution..." class="p-2 border rounded-md w-5/6 autosize-textarea" rows="4"></textarea>
                                    </div>
                                </div>
                                 <div class="flex justify-end pt-4 border-t mt-4">
                                    <button id="save-complaint-btn" type="button" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save Complaint</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div id="complaints-view-records-panel" class="hidden">
                        <div class="border rounded-lg p-6 bg-gray-50">
                             <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">View Complaint Records</h2>
                             <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Ref #</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Date</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Complainant</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Status</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="complaints-records-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Positive Arrests View -->
                <div id="positive-arrests-view" class="view-panel hidden">
                               <div id="positive-arrests-actions" class="flex justify-center space-x-4 mb-6">
                                    <button data-action="add" class="ob-action-btn px-6 py-2 rounded-lg bg-blue-500 text-white font-semibold shadow-md btn-hover-effect action-btn-active">Add Record</button>
                                    <button data-action="view" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">View Records</button>
                                </div>
                                <div id="positive-arrests-form-panel">
                                    <div class="border rounded-lg p-6 bg-gray-50">
                                        <h2 id="arrest-form-title" class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">Positive Arrests</h2>
                                        <form id="positive-arrests-form" class="space-y-6">
                                            <input type="hidden" id="arrest-record-id">
                                            <!-- Basic Info -->
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div class="flex items-center">
                                                    <label class="w-1/3 text-gray-600 font-medium">Date Time Captured:</label>
                                                    <input type="datetime-local" id="arrest-datetime-captured" class="p-2 border rounded-md w-2/3">
                                                </div>
                                                <div class="flex items-center">
                                                    <label class="w-1/3 text-gray-600 font-medium">Information Entered by:</label>
                                                    <input type="text" id="arrest-entered-by" class="p-2 border rounded-md w-2/3">
                                                </div>
                                                <div class="flex items-center">
                                                    <label class="w-1/3 text-gray-600 font-medium">Division:</label>
                                                    <select id="pa-division-select" class="p-2 border rounded-md w-2/3"></select>
                                                </div>
                                                <div class="flex items-center">
                                                    <label class="w-1/3 text-gray-600 font-medium">Date:</label>
                                                    <input type="date" id="arrest-date" class="p-2 border rounded-md w-2/3">
                                                </div>
                                                <div class="flex items-center col-span-1 md:col-span-2">
                                                    <label class="w-1/6 text-gray-600 font-medium">Address of Crime:</label>
                                                    <textarea id="arrest-address" class="p-2 border rounded-md w-5/6 h-20 autosize-textarea"></textarea>
                                                </div>
                                            </div>

                                            <!-- Crime Details Sections -->
                                            <div id="pa-crime-details-section" class="space-y-4">
                                                <!-- Crime 1 -->
                                                <div class="border-t pt-4 mt-4">
                                                     <h3 class="text-lg font-semibold text-gray-700 mb-4">Crime 1</h3>
                                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">Nature of Crime:</label>
                                                             <select id="crime-1-nature" class="pa-nature-crime-select p-2 border rounded-md w-2/3"></select>
                                                         </div>
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">Police station:</label>
                                                             <select id="crime-1-station" class="pa-police-station-select p-2 border rounded-md w-2/3"></select>
                                                         </div>
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">SAPS Case number:</label>
                                                             <input type="text" id="crime-1-case" class="p-2 border rounded-md w-2/3">
                                                         </div>
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">SAPS 13 Number:</label>
                                                             <div id="crime-1-sap" class="w-2/3 sap-container">
                                                                 <input type="text" class="p-2 border rounded-md numeric-only w-full mb-2" placeholder="Number">
                                                                 <div class="flex items-center space-x-2">
                                                                     <select class="p-2 border rounded-md sap-month"></select>
                                                                     <span class="text-gray-500">/</span>
                                                                     <select class="p-2 border rounded-md sap-year"></select>
                                                                 </div>
                                                             </div>
                                                         </div>
                                                     </div>
                                                </div>
                                                <!-- Crime 2 -->
                                                <div class="border-t pt-4 mt-4">
                                                     <h3 class="text-lg font-semibold text-gray-700 mb-4">Crime 2</h3>
                                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">Nature of Crime:</label>
                                                             <select id="crime-2-nature" class="pa-nature-crime-select p-2 border rounded-md w-2/3"></select>
                                                         </div>
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">Police station:</label>
                                                             <select id="crime-2-station" class="pa-police-station-select p-2 border rounded-md w-2/3"></select>
                                                         </div>
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">SAPS Case number:</label>
                                                             <input type="text" id="crime-2-case" class="p-2 border rounded-md w-2/3">
                                                         </div>
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">SAPS 13 Number:</label>
                                                             <div id="crime-2-sap" class="w-2/3 sap-container">
                                                                 <input type="text" class="p-2 border rounded-md numeric-only w-full mb-2" placeholder="Number">
                                                                 <div class="flex items-center space-x-2">
                                                                     <select class="p-2 border rounded-md sap-month"></select>
                                                                     <span class="text-gray-500">/</span>
                                                                     <select class="p-2 border rounded-md sap-year"></select>
                                                                 </div>
                                                             </div>
                                                         </div>
                                                     </div>
                                                </div>
                                                <!-- Crime 3 -->
                                                <div class="border-t pt-4 mt-4">
                                                     <h3 class="text-lg font-semibold text-gray-700 mb-4">Crime 3</h3>
                                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">Nature of Crime:</label>
                                                             <select id="crime-3-nature" class="pa-nature-crime-select p-2 border rounded-md w-2/3"></select>
                                                         </div>
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">Police station:</label>
                                                             <select id="crime-3-station" class="pa-police-station-select p-2 border rounded-md w-2/3"></select>
                                                         </div>
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">SAPS Case number:</label>
                                                             <input type="text" id="crime-3-case" class="p-2 border rounded-md w-2/3">
                                                         </div>
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">SAPS 13 Number:</label>
                                                             <div id="crime-3-sap" class="w-2/3 sap-container">
                                                                 <input type="text" class="p-2 border rounded-md numeric-only w-full mb-2" placeholder="Number">
                                                                 <div class="flex items-center space-x-2">
                                                                     <select class="p-2 border rounded-md sap-month"></select>
                                                                     <span class="text-gray-500">/</span>
                                                                     <select class="p-2 border rounded-md sap-year"></select>
                                                                 </div>
                                                             </div>
                                                         </div>
                                                     </div>
                                                </div>
                                                <!-- Crime 4 -->
                                                <div class="border-t pt-4 mt-4">
                                                     <h3 class="text-lg font-semibold text-gray-700 mb-4">Crime 4</h3>
                                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">Nature of Crime:</label>
                                                             <select id="crime-4-nature" class="pa-nature-crime-select p-2 border rounded-md w-2/3"></select>
                                                         </div>
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">Police station:</label>
                                                             <select id="crime-4-station" class="pa-police-station-select p-2 border rounded-md w-2/3"></select>
                                                         </div>
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">SAPS Case number:</label>
                                                             <input type="text" id="crime-4-case" class="p-2 border rounded-md w-2/3">
                                                         </div>
                                                         <div class="flex items-center">
                                                             <label class="w-1/3 text-gray-600 font-medium">SAPS 13 Number:</label>
                                                             <div id="crime-4-sap" class="w-2/3 sap-container">
                                                                 <input type="text" class="p-2 border rounded-md numeric-only w-full mb-2" placeholder="Number">
                                                                 <div class="flex items-center space-x-2">
                                                                     <select class="p-2 border rounded-md sap-month"></select>
                                                                     <span class="text-gray-500">/</span>
                                                                     <select class="p-2 border rounded-md sap-year"></select>
                                                                 </div>
                                                             </div>
                                                         </div>
                                                     </div>
                                                </div>
                                            </div>

                                             <!-- Pictures Section -->
                                            <div id="pa-evidence-section" class="border-t pt-4 mt-4">
                                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Evidence Pictures</h3>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    <div class="flex items-center">
                                                        <label class="w-1/3 text-gray-600 font-medium">Pictures of Scene:</label>
                                                        <input type="file" multiple id="arrest-pics-scene" class="p-1 border rounded-md w-2/3">
                                                    </div>
                                                    <div class="flex items-center">
                                                        <label class="w-1/3 text-gray-600 font-medium">Picture of Statement:</label>
                                                        <input type="file" id="arrest-pic-statement1" class="p-1 border rounded-md w-2/3">
                                                    </div>
                                                     <div class="flex items-center">
                                                        <label class="w-1/3 text-gray-600 font-medium">Picture of Statement 2:</label>
                                                        <input type="file" id="arrest-pic-statement2" class="p-1 border rounded-md w-2/3">
                                                    </div>
                                                     <div class="flex items-center">
                                                        <label class="w-1/3 text-gray-600 font-medium">Picture of Statement 3:</label>
                                                        <input type="file" id="arrest-pic-statement3" class="p-1 border rounded-md w-2/3">
                                                    </div>
                                                     <div class="flex items-center">
                                                        <label class="w-1/3 text-gray-600 font-medium">Picture of Statement 4:</label>
                                                        <input type="file" id="arrest-pic-statement4" class="p-1 border rounded-md w-2/3">
                                                    </div>
                                                </div>
                                            </div>
                                            
                                             <!-- Suspects Section -->
                                            <div id="pa-suspects-section" class="border-t pt-4 mt-4">
                                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Suspect Details</h3>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                                     <div class="flex items-center">
                                                        <label class="w-1/3 text-gray-600 font-medium">Total Suspects:</label>
                                                        <input type="text" id="arrest-total-suspects" class="p-2 border rounded-md w-2/3 numeric-only">
                                                    </div>
                                                </div>
                                                <div class="flex justify-end mb-2">
                                                    <button type="button" id="add-suspect-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md btn-hover-effect">Add Suspect</button>
                                                </div>
                                                <div class="overflow-x-auto">
                                                    <table class="min-w-full bg-white border">
                                                        <thead class="bg-gray-200">
                                                            <tr>
                                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Suspect Name</th>
                                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">ID Number</th>
                                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">ID Picture</th>
                                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Action</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="suspects-tbody"></tbody>
                                                    </table>
                                                </div>
                                            </div>

                                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                                                  <div class="flex items-center">
                                                    <label class="w-1/3 text-gray-600 font-medium">Arrested By:</label>
                                                    <input type="text" id="arrest-arrested-by" class="p-2 border rounded-md w-2/3">
                                                </div>
                                            </div>

                                             <div class="flex justify-end pt-4">
                                                <button type="button" id="save-arrest-btn" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save Arrest</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                 <div id="positive-arrests-view-records-panel" class="hidden">
                                    <div class="border rounded-lg p-6 bg-gray-50">
                                        <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">View Arrest Records</h2>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full bg-white border">
                                                <thead class="bg-gray-200">
                                                    <tr>
                                                        <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Date</th>
                                                        <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Division</th>
                                                        <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Address</th>
                                                        <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Suspects</th>
                                                        <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="positive-arrests-records-tbody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                </div>

                <!-- SOT Positives View -->
                <div id="sot-view" class="view-panel hidden">
                    <div id="sot-actions" class="flex justify-center space-x-4 mb-6">
                        <button data-action="add" class="ob-action-btn px-6 py-2 rounded-lg bg-blue-500 text-white font-semibold shadow-md btn-hover-effect action-btn-active">Add Record</button>
                        <button data-action="view" class="ob-action-btn px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700 font-medium btn-hover-effect">View Records</button>
                    </div>
                    <div id="sot-form-panel">
                        <div class="border rounded-lg p-6 bg-gray-50">
                            <h2 id="sot-form-title" class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">SOT Positives</h2>
                            <form id="sot-form" class="space-y-6">
                                <input type="hidden" id="sot-record-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Status -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Status:</label>
                                        <div id="sot-status-buttons" class="flex space-x-2">
                                            <button type="button" data-status="Open" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700 status-btn-active">Open</button>
                                            <button type="button" data-status="Closed" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700">Closed</button>
                                            <button type="button" data-status="Pending" class="status-btn px-4 py-2 rounded-md bg-gray-200 text-gray-700">Pending</button>
                                        </div>
                                    </div>
                                    <!-- Date Opened -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Date Opened:</label>
                                        <input type="datetime-local" id="sot-date-opened" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <!-- Date Assigned -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Date Assigned:</label>
                                        <input type="datetime-local" id="sot-date-assigned" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <!-- Date Closed -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Date Closed:</label>
                                        <input type="datetime-local" id="sot-date-closed" class="p-2 border rounded-md w-2/3">
                                    </div>
                                     <!-- Investigation Close Date -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Investigation Close Date:</label>
                                        <input type="date" id="sot-date-investigation-closed" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <!-- Marshall Client -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Marshall Client:</label>
                                        <input type="text" id="sot-client" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <!-- Unit number -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Unit number:</label>
                                        <input type="text" id="sot-unit-number" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <!-- Business Name -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Business Name:</label>
                                        <input type="text" id="sot-business-name" class="p-2 border rounded-md w-2/3">
                                    </div>
                                    <!-- Incident Type -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Incident Type:</label>
                                        <select id="sot-incident-type-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                    <!-- Person Assigned -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Person Assigned:</label>
                                        <select id="sot-person-assigned-select" class="p-2 border rounded-md w-2/3"></select>
                                    </div>
                                    <!-- Client Contacted -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Client Contacted:</label>
                                        <input type="checkbox" id="sot-client-contacted" class="h-5 w-5">
                                    </div>
                                     <!-- Contact Number -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Contact Number:</label>
                                        <input type="text" id="sot-contact-number" class="p-2 border rounded-md w-2/3 numeric-only">
                                    </div>
                                    <!-- Onsite Meeting -->
                                    <div class="flex items-center">
                                        <label class="w-1/3 text-gray-600 font-medium">Onsite Meeting:</label>
                                        <input type="checkbox" id="sot-onsite-meeting" class="h-5 w-5">
                                    </div>
                                </div>

                                <!-- Textareas and combined fields -->
                                <div class="space-y-4 border-t pt-4 mt-4">
                                     <!-- Address Of Incident -->
                                    <div class="flex items-start">
                                        <label class="w-1/4 text-gray-600 font-medium pt-2">Address Of Incident:</label>
                                        <textarea id="sot-address" class="p-2 border rounded-md w-3/4 autosize-textarea" rows="3"></textarea>
                                    </div>
                                    <!-- History Report -->
                                    <div class="flex items-start">
                                        <label class="w-1/4 text-gray-600 font-medium pt-2">History Report:</label>
                                        <input type="file" id="sot-history-report" class="p-1 border rounded-md w-3/4">
                                    </div>
                                    <!-- Feedback/Investigation -->
                                    <div class="flex items-start">
                                        <label class="w-1/4 text-gray-600 font-medium pt-2">Feedback/Investigation:</label>
                                        <textarea id="sot-feedback" class="p-2 border rounded-md w-3/4 autosize-textarea" rows="4"></textarea>
                                    </div>
                                </div>

                                <div id="sot-comments-section" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 border-t pt-4 mt-4">
                                    <!-- CCTV -->
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-3 text-gray-600 font-medium">
                                            <input type="checkbox" data-target="cctv-comments" class="h-5 w-5 sot-comment-toggle">
                                            <span>CCTV Footage</span>
                                        </label>
                                        <textarea id="cctv-comments" placeholder="CCTV Comments" class="p-2 border rounded-md w-full hidden autosize-textarea" rows="2"></textarea>
                                    </div>
                                    <!-- Case Open -->
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-3 text-gray-600 font-medium">
                                            <input type="checkbox" data-target="case-open-comments" class="h-5 w-5 sot-comment-toggle">
                                            <span>Case Open</span>
                                        </label>
                                        <textarea id="case-open-comments" placeholder="Case Open Comments" class="p-2 border rounded-md w-full hidden autosize-textarea" rows="2"></textarea>
                                    </div>
                                    <!-- Technical Assistance -->
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-3 text-gray-600 font-medium">
                                            <input type="checkbox" data-target="technical-comments" class="h-5 w-5 sot-comment-toggle">
                                            <span>Technical Assistance</span>
                                        </label>
                                        <textarea id="technical-comments" placeholder="Technical Comments" class="p-2 border rounded-md w-full hidden autosize-textarea" rows="2"></textarea>
                                    </div>
                                    <!-- Sales Assistance -->
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-3 text-gray-600 font-medium">
                                            <input type="checkbox" data-target="sales-comments" class="h-5 w-5 sot-comment-toggle">
                                            <span>Sales Assistance</span>
                                        </label>
                                        <textarea id="sales-comments" placeholder="Sales Comments" class="p-2 border rounded-md w-full hidden autosize-textarea" rows="2"></textarea>
                                    </div>
                                    <!-- Response Assistance -->
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-3 text-gray-600 font-medium">
                                            <input type="checkbox" data-target="response-comments" class="h-5 w-5 sot-comment-toggle">
                                            <span>Response Assistance</span>
                                        </label>
                                        <textarea id="response-comments" placeholder="Response Comments" class="p-2 border rounded-md w-full hidden autosize-textarea" rows="2"></textarea>
                                    </div>
                                    <!-- Control Room Assistance -->
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-3 text-gray-600 font-medium">
                                            <input type="checkbox" data-target="control-room-comments" class="h-5 w-5 sot-comment-toggle">
                                            <span>Control Room Assistance</span>
                                        </label>
                                        <textarea id="control-room-comments" placeholder="Control Room Comments" class="p-2 border rounded-md w-full hidden autosize-textarea" rows="2"></textarea>
                                    </div>
                                    <!-- Complaints/Compliments -->
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-3 text-gray-600 font-medium">
                                            <input type="checkbox" data-target="complaints-comments" class="h-5 w-5 sot-comment-toggle">
                                            <span>Complaints/Compliments</span>
                                        </label>
                                        <textarea id="complaints-comments" placeholder="Complaints/Compliments Comments" class="p-2 border rounded-md w-full hidden autosize-textarea" rows="2"></textarea>
                                    </div>
                                    <!-- Risk Assessment -->
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-3 text-gray-600 font-medium">
                                            <input type="checkbox" data-target="risk-assessment-comments" class="h-5 w-5 sot-comment-toggle">
                                            <span>Risk Assessment</span>
                                        </label>
                                        <textarea id="risk-assessment-comments" placeholder="Risk Assessment Comments" class="p-2 border rounded-md w-full hidden autosize-textarea" rows="2"></textarea>
                                    </div>
                                </div>

                                <!-- Save Button -->
                                <div class="flex justify-end pt-4">
                                    <button type="button" id="save-sot-btn" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save SOT Record</button>
                                </div>
                            </form>
                        </div>
                    </div>
                     <div id="sot-view-records-panel" class="hidden">
                        <div class="border rounded-lg p-6 bg-gray-50">
                            <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">View SOT Records</h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Date Opened</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Client</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Incident Type</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Status</th>
                                            <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sot-records-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manage Users View -->
                <div id="manage-users-view" class="view-panel hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Users</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Add/Edit User Form -->
                        <div class="lg:col-span-1">
                             <div class="border rounded-lg p-6 bg-gray-50">
                                <h3 id="user-form-title" class="text-xl font-semibold mb-4">Add New User</h3>
                                <form id="manage-user-form" class="space-y-4">
                                    <input type="hidden" id="user-id-input">
                                    <div>
                                        <label for="user-name" class="block text-sm font-medium text-gray-700">Name</label>
                                        <input type="text" id="user-name" class="mt-1 p-2 border rounded-md w-full" required>
                                    </div>
                                    <div>
                                        <label for="user-surname" class="block text-sm font-medium text-gray-700">Surname</label>
                                        <input type="text" id="user-surname" class="mt-1 p-2 border rounded-md w-full" required>
                                    </div>
                                    <div>
                                        <label for="user-username" class="block text-sm font-medium text-gray-700">Username</label>
                                        <input type="text" id="user-username" class="mt-1 p-2 border rounded-md w-full" required>
                                    </div>
                                    <div>
                                        <label for="user-email" class="block text-sm font-medium text-gray-700">Email</label>
                                        <input type="email" id="user-email" class="mt-1 p-2 border rounded-md w-full" required>
                                    </div>
                                    <div>
                                        <label for="user-department" class="block text-sm font-medium text-gray-700">Department</label>
                                        <select id="user-department" class="mt-1 p-2 border rounded-md w-full" required></select>
                                    </div>
                                    <div>
                                        <label for="user-role" class="block text-sm font-medium text-gray-700">Role</label>
                                        <select id="user-role" class="mt-1 p-2 border rounded-md w-full" required></select>
                                    </div>
                                    <div>
                                        <label for="user-password" class="block text-sm font-medium text-gray-700">Password</label>
                                        <input type="password" id="user-password" class="mt-1 p-2 border rounded-md w-full" placeholder="Unchanged if empty on edit" autocomplete="new-password">
                                    </div>
                                    <div class="flex justify-end space-x-3 pt-4">
                                         <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg btn-hover-effect hidden">Cancel</button>
                                        <button type="submit" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save User</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- User List -->
                        <div class="lg:col-span-2">
                            <div class="border rounded-lg p-6 bg-gray-50">
                                <h3 class="text-xl font-semibold mb-4">Existing Users</h3>
                                <div class="mb-4">
                                    <label for="user-search-input" class="sr-only">Search Users</label>
                                    <input type="text" id="user-search-input" class="mt-1 p-2 border rounded-md w-full" placeholder="Search by name, surname, username, or email...">
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white border">
                                        <thead class="bg-gray-200">
                                            <tr>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Name</th>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Username</th>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Email</th>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Department</th>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Role</th>
                                                <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="users-tbody">
                                            <!-- User rows will be dynamically inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Department & Roles View -->
                <div id="department-roles-view" class="view-panel hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Departments & Roles</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                        
                        <!-- Management Column -->
                        <div class="space-y-8">
                             <!-- Manage Departments -->
                            <div>
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">Departments</h3>
                                <div class="border rounded-lg p-4 bg-gray-50 space-y-4">
                                    <form id="add-department-form" class="flex gap-2">
                                        <input type="text" id="new-department-input" class="flex-grow p-2 border rounded-md" placeholder="New department name" required>
                                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md btn-hover-effect">Add</button>
                                    </form>
                                    <div id="department-list" class="category-list max-h-48 overflow-y-auto space-y-2">
                                        <!-- Departments will be listed here -->
                                    </div>
                                </div>
                            </div>

                             <!-- Manage Roles -->
                             <div>
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">Roles</h3>
                                <div class="border rounded-lg p-4 bg-gray-50 space-y-4">
                                    <form id="add-role-form" class="flex gap-2">
                                        <input type="text" id="new-role-input" class="flex-grow p-2 border rounded-md" placeholder="New role name" required>
                                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md btn-hover-effect">Add</button>
                                    </form>
                                    <div id="role-list" class="category-list max-h-48 overflow-y-auto space-y-2">
                                        <!-- Roles will be listed here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assignment Column -->
                        <div>
                             <h3 class="text-xl font-semibold mb-4 text-gray-700">Assign Roles to Department</h3>
                             <div class="border rounded-lg p-4 bg-gray-50 space-y-4">
                                 <div>
                                    <label for="assign-dept-select" class="block text-sm font-medium text-gray-700 mb-2">Select Department:</label>
                                    <select id="assign-dept-select" class="w-full p-2 border rounded-md"></select>
                                </div>
                                <div id="role-assignment-list" class="category-list max-h-96 overflow-y-auto space-y-2 border-t pt-4">
                                    <!-- Role checkboxes will appear here -->
                                </div>
                                <div class="flex justify-end pt-4">
                                    <button id="save-assignment-btn" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save Assignments</button>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- User Permissions View -->
                <div id="user-permissions-view" class="view-panel hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">User Permissions</h2>
                    <div class="border rounded-lg p-6 bg-gray-50">
                        <div class="mb-4">
                            <label for="permissions-user-search-input" class="block text-sm font-medium text-gray-700 mb-1">Search by User Name, Surname, or Username:</label>
                            <input type="text" id="permissions-user-search-input" class="p-2 border rounded-md w-full" placeholder="Type a name, surname, or username to filter...">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                             <div>
                                <label for="permissions-department-select" class="block text-sm font-medium text-gray-700 mb-1">Filter by Department:</label>
                                <select id="permissions-department-select" class="p-2 border rounded-md w-full"></select>
                            </div>
                             <div>
                                <label for="permissions-role-select" class="block text-sm font-medium text-gray-700 mb-1">Filter by Role:</label>
                                <select id="permissions-role-select" class="p-2 border rounded-md w-full" disabled></select>
                                <!-- MODIFICATION: Added button to load role defaults -->
                                <button id="load-role-permissions-btn" class="hidden mt-2 w-full px-4 py-2 bg-indigo-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 btn-hover-effect">
                                    Load Role Defaults
                                </button>
                            </div>
                             <div>
                                <label for="permissions-user-select" class="block text-sm font-medium text-gray-700 mb-1">Select User:</label>
                                <select id="permissions-user-select" class="p-2 border rounded-md w-full" disabled></select>
                            </div>
                        </div>

                        <div id="permissions-container" class="space-y-4 pt-4 border-t">
                             <!-- Headers -->
                            <div class="grid grid-cols-7 items-center font-semibold text-gray-600 px-4">
                                <div class="col-span-2">Tab</div>
                                <div class="text-center">Access</div>
                                <div class="text-center">Add</div>
                                <div class="text-center">Remove</div>
                                <div class="text-center">Update</div>
                                <div class="text-center">View</div>
                            </div>
                            <!-- Permissions Rows will be dynamically generated here -->
                        </div>
                         <!-- Save Button -->
                        <div class="flex justify-end pt-6 mt-6 border-t">
                            <button id="save-permissions-btn" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg btn-hover-effect">Save Permissions</button>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    
    <script type="module">
        // This script uses MOCK DATA for frontend development.
        // It does NOT connect to a backend server.
        
        // --- STATE MANAGEMENT ---
        const currentDate = new Date('2025-10-14T09:44:00');
        let obCounter = 1;
        let complaintCounter = 1;
        let currentUser = 'admin'; // 'admin' or a user ID
        
        // --- MOCK DATA (Replaces the backend) ---
        let users = [
            { id: 1, name: 'John', surname: 'Doe', username: 'johnd', email: 'john.d@example.com', department: 'SOT', role: 'SOT Manager' },
            { id: 2, name: 'Jane', surname: 'Smith', username: 'janes', email: 'jane.s@example.com', department: 'Reaction', role: 'Reaction Manager' },
            { id: 3, name: 'Mahesh', surname: 'Palad', username: 'maheshp', email: 'mahesh.p@example.com', department: 'I.T', role: 'I.T' }
        ];

        let obRecords = [
            { id: 1, obNumber: 1, created: '2025-10-13T10:00', timeFrom: '2025-10-13T09:00', timeTo: '2025-10-13T09:30', createdBy: 'John Doe', obType: 'House breaking', obCategory: 'Crime', policeStation: 'Durban North', casNumber: 'CAS123', sapNumber: 'SAP456', area: 'Durban North', clientAccount: 'ACC987', contactNo: '0821234567', address1: '123 Marine Drive', status: 'Open', comments: 'Suspect seen fleeing the scene.' },
            { id: 2, obNumber: 2, created: '2025-10-12T15:30', timeFrom: '2025-10-12T15:00', timeTo: '2025-10-12T15:15', createdBy: 'Jane Smith', obType: 'Armed robbery', obCategory: 'Crime', policeStation: 'Berea', casNumber: 'CAS124', sapNumber: 'SAP457', area: 'Morningside', clientAccount: 'ACC988', contactNo: '0831234568', address1: '456 Florida Road', status: 'Closed', comments: 'Perpetrators were armed.' }
        ];
        obCounter = obRecords.length + 1;

        let recoveryRecords = [];
        let complaintRecords = [];
        let arrestRecords = [];
        let sotRecords = [];


        const departmentRoles = {
            'SOT': ['SOT Manager', 'SOT Member'],
            'Reaction': ['Reaction Officer', 'Reaction Supervisor', 'Reaction Manager'],
            'Control Room': ['Control Room Operator', 'Control Room Supervisor', 'Control Room Manager'],
            'Camera Room': ['Camera Room Admin', 'Camera Room Supervisor'],
            'Sales': ['Sales Field', 'Sales Admin', 'SalesManager'],
            'Marketing': ['Marketing Manager', 'Marketing Staff'],
            'I.T': ['I.T'],
            'Customer Care': ['Customer Care Manager', 'Customer Care Admin']
        };

        let dropdownOptions = {
            obType: ["Abduction", "Accident", "Armed robbery", "Assault", "Business breaking", "Business robbery", "Common robbery", "House breaking", "House robbery", "Theft"],
            policeStation: ["Durban North", "Berea", "Durban Central", "Mayville", "Westville", "Pinetown"],
            area: ["Durban North", "Umhlanga", "La Lucia", "Glenwood", "Morningside"],
            vehicleMake: ["Toyota", "Volkswagen", "Ford", "Hyundai", "BMW", "Mercedes-Benz"],
            ethnicity: ["Asian", "Black", "Coloured", "Indian", "White", "Other"],
            division: ["SOT", "Reaction", "Westmead (sector 1)", "Westmead (sector 2)"],
            recoveryType: ["Vehicle", "Items"],
            incidentType: ["Hijacked", "Stolen", "Missing person", "House breaking"],
            natureOfCrime: ["Armed robbery", "House breaking", "Theft of motor vehicle", "Common robbery", "Assault"],
            sotPersonAssigned: ["Jono", "Jaco", "Michael", "Zandre", "Derek"],
            natureOfComplaint: ["Poor Service", "Staff Attitude", "Response Time", "Billing Issue", "Other"],
            department: Object.keys(departmentRoles),
            role: [...new Set(Object.values(departmentRoles).flat())]
        };

        // --- NEW: ROLE-BASED PERMISSION MAPPING ---
        const rolePermissions = {
            'SOT Manager': {
                tabs: {
                    'ob-entry-view': { access: true, add: true, remove: true, update: true, view: true },
                    'category-edit-view': { access: true },
                    'recoveries-view': { access: true, add: true, remove: true, update: true, view: true },
                    'complaints-view': { access: true, add: true, remove: false, update: true, view: true },
                    'positive-arrests-view': { access: true, add: true, remove: true, update: true, view: true },
                    'sot-view': { access: true, add: true, remove: true, update: true, view: true },
                    'manage-users-view': { access: true },
                    'department-roles-view': { access: true },
                    'user-permissions-view': { access: true },
                }
            },
            'Reaction Manager': {
                tabs: {
                    'ob-entry-view': { access: true, add: true, remove: true, update: true, view: true },
                    'recoveries-view': { access: true, add: true, remove: true, update: true, view: true },
                    'complaints-view': { access: true, add: true, remove: false, update: true, view: true },
                    'positive-arrests-view': { access: true, add: true, remove: true, update: true, view: true },
                    'manage-users-view': { access: true },
                }
            },
            'Reaction Officer': {
                tabs: {
                    'ob-entry-view': { access: true, add: true, remove: false, update: true, view: true },
                    'recoveries-view': { access: true, add: true, remove: false, update: true, view: true },
                    'positive-arrests-view': { access: true, add: true, remove: false, update: true, view: true },
                }
            },
            'Control Room Operator': {
                 tabs: {
                    'ob-entry-view': { access: true, add: true, remove: false, update: true, view: true },
                    'recoveries-view': { access: true, add: true, remove: false, update: true, view: true },
                }
            }
        };

        let userPermissions = {
            '1': JSON.parse(JSON.stringify(rolePermissions['SOT Manager'])),
            '2': JSON.parse(JSON.stringify(rolePermissions['Reaction Manager']))
        };

        // --- ELEMENT REFERENCES ---
        const sidebarNav = document.getElementById('sidebar-nav');
        const viewPanels = document.querySelectorAll('.view-panel');
        const loginAsSelect = document.getElementById('login-as-select');
        const userForm = document.getElementById('manage-user-form');
        const userFormTitle = document.getElementById('user-form-title');
        const userIdInput = document.getElementById('user-id-input');
        const userNameInput = document.getElementById('user-name');
        const userSurnameInput = document.getElementById('user-surname');
        const userUsernameInput = document.getElementById('user-username');
        const userEmailInput = document.getElementById('user-email');
        const userDepartmentSelect = document.getElementById('user-department');
        const userRoleSelect = document.getElementById('user-role');
        const userPasswordInput = document.getElementById('user-password');
        const usersTbody = document.getElementById('users-tbody');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const userSearchInput = document.getElementById('user-search-input');
        const permissionsUserSearchInput = document.getElementById('permissions-user-search-input');
        const permissionsDeptSelect = document.getElementById('permissions-department-select');
        const permissionsRoleSelect = document.getElementById('permissions-role-select');
        const permissionsUserSelect = document.getElementById('permissions-user-select');
        const permissionsContainer = document.getElementById('permissions-container');
        const savePermissionsBtn = document.getElementById('save-permissions-btn');
        const createdByUserSpan = document.getElementById('created-by-user');
        const loadRolePermissionsBtn = document.getElementById('load-role-permissions-btn');


        // Department & Role Management Elements
        const addDepartmentForm = document.getElementById('add-department-form');
        const newDepartmentInput = document.getElementById('new-department-input');
        const departmentList = document.getElementById('department-list');
        const addRoleForm = document.getElementById('add-role-form');
        const newRoleInput = document.getElementById('new-role-input');
        const roleList = document.getElementById('role-list');
        const assignDeptSelect = document.getElementById('assign-dept-select');
        const roleAssignmentList = document.getElementById('role-assignment-list');
        const saveAssignmentBtn = document.getElementById('save-assignment-btn');


        // Modals
        const confirmModal = document.getElementById('confirmation-modal');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const successModal = document.getElementById('success-modal');
        const successModalTitle = document.getElementById('success-modal-title');
        const successModalMessage = document.getElementById('success-modal-message');
        const successModalOkBtn = document.getElementById('success-modal-ok-btn');

        // --- UTILITY FUNCTIONS ---
        const toSentenceCase = (str) => {
            if (typeof str !== 'string' || str.length === 0) return str;
            const lower = str.toLowerCase();
            return lower.charAt(0).toUpperCase() + lower.slice(1);
        };

        const showConfirmationModal = (message, onConfirmCallback) => {
            confirmModalMessage.textContent = message;
            confirmModal.style.display = 'flex';
            
            const newButtons = document.getElementById('modal-buttons').cloneNode(true);
            document.getElementById('modal-buttons').parentNode.replaceChild(newButtons, document.getElementById('modal-buttons'));

            newButtons.querySelector('#modal-confirm-btn').addEventListener('click', () => {
                confirmModal.style.display = 'none';
                onConfirmCallback();
            });
            newButtons.querySelector('#modal-cancel-btn').addEventListener('click', () => {
                confirmModal.style.display = 'none';
            });
        };

        const showSuccessModal = (title, message) => {
            successModalTitle.textContent = title;
            successModalMessage.textContent = message;
            successModal.style.display = 'flex';
        };

        // --- UI RENDERING FUNCTIONS ---

        const renderPermissionsTable = () => {
            const container = document.getElementById('permissions-container');
            
            // Clear existing dynamic rows, keeping the header
            container.querySelectorAll('.permission-row').forEach(row => row.remove());

            const navButtons = sidebarNav.querySelectorAll('button[data-view]');
            
            navButtons.forEach(btn => {
                const viewId = btn.dataset.view;
                const viewName = btn.querySelector('span')?.textContent.trim() || btn.textContent.trim();
                
                const row = document.createElement('div');
                row.className = 'permission-row grid grid-cols-7 items-center border-b py-3';
                row.dataset.viewName = viewId;

                row.innerHTML = `
                    <div class="col-span-2 font-semibold text-gray-700">${viewName}</div>
                    <div class="text-center"><input type="checkbox" data-action="access" class="h-5 w-5 tab-access-cb"></div>
                    <div class="text-center"><input type="checkbox" data-action="add" class="h-5 w-5 action-cb"></div>
                    <div class="text-center"><input type="checkbox" data-action="remove" class="h-5 w-5 action-cb"></div>
                    <div class="text-center"><input type="checkbox" data-action="update" class="h-5 w-5 action-cb"></div>
                    <div class="text-center"><input type="checkbox" data-action="view" class="h-5 w-5 action-cb"></div>
                `;
                container.appendChild(row);
            });
        };

        const renderCategoryEditor = (categoryKey) => {
            const categoryData = dropdownOptions[categoryKey] || [];
            const categorySelector = document.getElementById('category-selector');
            const editingCategoryName = document.getElementById('editing-category-name');
            const categoryItemList = document.getElementById('category-item-list');
            
            if (editingCategoryName) {
                if(categorySelector.options.length > 0) {
                   editingCategoryName.textContent = `Editing: ${categorySelector.options[categorySelector.selectedIndex].text}`;
                }
            }
            
            if (categoryItemList) {
                categoryItemList.innerHTML = '';
                categoryData.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center p-2 bg-white rounded-md shadow-sm';
                    itemDiv.innerHTML = `
                        <span class="flex-grow">${item}</span>
                        <button data-item="${item}" data-index="${index}" class="delete-item-btn text-red-500 hover:text-red-700 font-bold p-1">X</button>
                    `;
                    categoryItemList.appendChild(itemDiv);
                });
            }
        };

        const populateDropdown = (select, options, placeholder) => {
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = '';
            if (placeholder) {
                select.innerHTML += `<option value="">${placeholder}</option>`;
            }
            options.forEach(opt => {
                const value = typeof opt === 'object' ? opt.id : opt;
                const text = typeof opt === 'object' ? `${opt.name} ${opt.surname}` : opt;
                select.innerHTML += `<option value="${value}">${text}</option>`;
            });
            if(options.map(o => typeof o === 'object' ? o.id.toString() : o).includes(currentValue)){
                select.value = currentValue;
            }
        };
        
        const updateAllDropdowns = () => {
            populateDropdown(document.getElementById('ob-type-select'), dropdownOptions.obType || [], 'No OB Type Selected');
            populateDropdown(document.getElementById('police-station-select'), dropdownOptions.policeStation || [], 'No Police Station Selected');
            populateDropdown(document.getElementById('follow-up-user-select'), users, 'No User Selected');
            populateDropdown(document.getElementById('area-select'), dropdownOptions.area || [], 'No Area Selected');
            populateDropdown(document.getElementById('recovery-vehicle-brand-select'), dropdownOptions.vehicleMake || [], 'No Vehicle Brand Selected');
            populateDropdown(document.getElementById('recovery-ps-from-select'), dropdownOptions.policeStation || [], 'No Police Station Selected');
            populateDropdown(document.getElementById('recovery-ps-recovered-select'), dropdownOptions.policeStation || [], 'No Police Station Selected');
            populateDropdown(document.getElementById('recovery-division-select'), dropdownOptions.division || [], 'No Division Selected');
            populateDropdown(document.getElementById('recovery-type-select'), dropdownOptions.recoveryType || [], 'No Recovery Type Selected');
            populateDropdown(document.getElementById('recovery-incident-type-select'), dropdownOptions.incidentType || [], 'No Incident Type Selected');
            populateDropdown(document.getElementById('pa-division-select'), dropdownOptions.division || [], 'No Division Selected');
            document.querySelectorAll('.pa-nature-crime-select').forEach(s => populateDropdown(s, dropdownOptions.natureOfCrime || [], 'No Crime Selected'));
            document.querySelectorAll('.pa-police-station-select').forEach(s => populateDropdown(s, dropdownOptions.policeStation || [], 'No Police Station Selected'));
            populateDropdown(document.getElementById('sot-incident-type-select'), dropdownOptions.incidentType || [], 'No Incident Type Selected');
            populateDropdown(document.getElementById('sot-person-assigned-select'), dropdownOptions.sotPersonAssigned || [], 'No User Assigned');
            
            // Complaint dropdowns
            populateDropdown(document.getElementById('complaint-department-select'), dropdownOptions.department || [], 'Select Department');
            populateDropdown(document.getElementById('complaint-user-select'), users, 'Select User');
            populateDropdown(document.getElementById('complaint-nature-select'), dropdownOptions.natureOfComplaint || [], 'Select Nature of Complaint');
            populateDropdown(document.getElementById('complaint-assigned-select'), users, 'Assign to a user');


            populateDropdown(userDepartmentSelect, dropdownOptions.department || [], 'Select Department');
            populateDropdown(permissionsDeptSelect, dropdownOptions.department || [], 'All Departments');
            populateDropdown(assignDeptSelect, dropdownOptions.department || [], 'Select a Department');
            
            // OB Search Dropdowns
            populateDropdown(document.getElementById('ob-search-type'), dropdownOptions.obType, 'All OB Types');
            populateDropdown(document.getElementById('ob-search-station'), dropdownOptions.policeStation, 'All Stations');
            populateDropdown(document.getElementById('ob-search-area'), dropdownOptions.area, 'All Areas');

            // Initially populate role dropdowns with a placeholder or based on selection
            const selectedUserDept = userDepartmentSelect.value;
            populateDropdown(userRoleSelect, selectedUserDept ? departmentRoles[selectedUserDept] : [], 'Select a department first');

            const selectedPermDept = permissionsDeptSelect.value;
            populateDropdown(permissionsRoleSelect, selectedPermDept ? departmentRoles[selectedPermDept] : [], 'All Roles');


            filterPermissionUsers();
        };
        
        const renderUsersTable = (searchTerm = '') => {
            usersTbody.innerHTML = '';
            const normalizedSearch = searchTerm.toLowerCase().trim();

            const filteredUsers = users.filter(user => {
                if (!normalizedSearch) return true; // Show all if search is empty
                return (
                    user.name.toLowerCase().includes(normalizedSearch) ||
                    user.surname.toLowerCase().includes(normalizedSearch) ||
                    user.username.toLowerCase().includes(normalizedSearch) ||
                    user.email.toLowerCase().includes(normalizedSearch)
                );
            });

            filteredUsers.forEach(user => {
                usersTbody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="py-2 px-4 border-b">${user.name} ${user.surname}</td>
                        <td class="py-2 px-4 border-b">${user.username}</td>
                        <td class="py-2 px-4 border-b">${user.email}</td>
                        <td class="py-2 px-4 border-b">${user.department}</td>
                        <td class="py-2 px-4 border-b">${user.role}</td>
                        <td class="py-2 px-4 border-b space-x-2">
                            <button data-id="${user.id}" class="edit-user-btn text-blue-500 hover:underline">Edit</button>
                            <button data-id="${user.id}" class="delete-user-btn text-red-500 hover:underline">Delete</button>
                        </td>
                    </tr>
                `;
            });
        };
        
        const renderPermissions = (userId) => {
            const allCheckboxes = permissionsContainer.querySelectorAll('input[type="checkbox"]');
            
            if (!userId) {
                allCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.disabled = true;
                });
                return;
            }
            
            const permissions = userPermissions[userId] || { tabs: {} };

            document.querySelectorAll('.permission-row').forEach(row => {
                const view = row.dataset.viewName;
                const tabPerms = permissions.tabs[view] || {};
                
                row.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = tabPerms[cb.dataset.action] || false;
                     cb.disabled = false; // Enable all checkboxes for manual control when a user is selected
                });
            });
        };

        const handlePermissionChange = (event) => {
            const selectedUserId = permissionsUserSelect.value;
            if (!selectedUserId) return;

            const checkbox = event.target;
            const action = checkbox.dataset.action;
            const row = checkbox.closest('.permission-row');
            const view = row.dataset.viewName;

            if (!userPermissions[selectedUserId]) userPermissions[selectedUserId] = { tabs: {} };
            if (!userPermissions[selectedUserId].tabs[view]) userPermissions[selectedUserId].tabs[view] = {};

            userPermissions[selectedUserId].tabs[view][action] = checkbox.checked;

            const accessCheckbox = row.querySelector('.tab-access-cb');
            const actionCheckboxes = row.querySelectorAll('.action-cb');
            
            if (action === 'access' && !checkbox.checked) {
                // If access is unchecked, uncheck all action checkboxes
                actionCheckboxes.forEach(acb => {
                   acb.checked = false;
                   userPermissions[selectedUserId].tabs[view][acb.dataset.action] = false;
                });
            } else if (action !== 'access' && checkbox.checked) {
                // If an action checkbox is checked, ensure access is also checked
                if(!accessCheckbox.checked) {
                    accessCheckbox.checked = true;
                    userPermissions[selectedUserId].tabs[view]['access'] = true;
                }
            }
        };


        const populateLoginDropdown = () => {
            const currentVal = loginAsSelect.value || currentUser;
            loginAsSelect.innerHTML = '<option value="admin">Admin (Super User)</option>';
            users.forEach(user => {
                loginAsSelect.innerHTML += `<option value="${user.id}">${user.name} ${user.surname}</option>`;
            });
            loginAsSelect.value = currentVal;
            updateCreatedBy();
        };

        const updateCreatedBy = () => {
            if (currentUser === 'admin') {
                createdByUserSpan.textContent = 'Admin';
            } else {
                const user = users.find(u => u.id == currentUser);
                createdByUserSpan.textContent = user ? `${user.name} ${user.surname}` : 'Unknown User';
            }
        };

        const resetUserForm = () => {
            userForm.reset();
            userIdInput.value = '';
            userPasswordInput.placeholder = "Password";
            userFormTitle.textContent = 'Add New User';
            cancelEditBtn.classList.add('hidden');
        };

        const showView = (viewId, showRecords = false) => {
            viewPanels.forEach(panel => {
                panel.classList.toggle('hidden', panel.id !== viewId);
            });

             const viewPanel = document.getElementById(viewId);
            if (!viewPanel) return;

            const formPanel = viewPanel.querySelector('div[id$="-form-panel"]');
            const recordsPanel = viewPanel.querySelector('div[id$="-view-records-panel"]');
            
            if (formPanel && recordsPanel) {
                formPanel.classList.toggle('hidden', showRecords);
                recordsPanel.classList.toggle('hidden', !showRecords);
            }


            if (viewId === 'complaints-view') {
                updateComplaintRefNumber();
            }

            applyActionPermissions(viewId);
        };
        
        // --- PERMISSIONS LOGIC ---
        const applyPermissions = () => {
            const isAdmin = currentUser === 'admin';
            const userPerms = userPermissions[currentUser] || { tabs: {} };

            sidebarNav.querySelectorAll('button[data-view]').forEach(btn => {
                const view = btn.dataset.view;
                const hasAccess = isAdmin || (userPerms.tabs && userPerms.tabs[view] && userPerms.tabs[view].access);
                btn.classList.toggle('hidden', !hasAccess);
            });

            const activeViewButton = sidebarNav.querySelector('.active-btn');
            if(activeViewButton && activeViewButton.classList.contains('hidden')) {
                const firstVisibleButton = sidebarNav.querySelector('button[data-view]:not(.hidden)');
                if (firstVisibleButton) {
                   firstVisibleButton.click();
                } else {
                    // If no buttons are visible, hide all main content
                    showView(null);
                }
            }
            // Also re-apply action permissions for the current view
            const currentView = sidebarNav.querySelector('.active-btn')?.dataset.view;
            if (currentView) {
                applyActionPermissions(currentView);
            }
        };

        const applyActionPermissions = (viewId) => {
            const viewPanel = document.getElementById(viewId);
            if (!viewPanel) return;

            const actionsContainer = viewPanel.querySelector('.flex.justify-center.space-x-4.mb-6');
            if (!actionsContainer) return;
            
            const isAdmin = currentUser === 'admin';
            const permissions = (userPermissions[currentUser]) ? userPermissions[currentUser].tabs[viewId] : null;

            actionsContainer.querySelectorAll('.ob-action-btn').forEach(btn => {
                const action = btn.dataset.action;
                const hasPermission = isAdmin || (permissions && permissions[action]);
                btn.style.display = hasPermission ? '' : 'none';
            });
        };
        
        const filterPermissionUsers = () => {
            const dept = permissionsDeptSelect.value;
            const role = permissionsRoleSelect.value;
            let filtered = users.filter(u => (!dept || u.department === dept) && (!role || u.role === role));
            populateDropdown(permissionsUserSelect, filtered, 'Select User');
            renderPermissions(null);
        };

        const updateComplaintRefNumber = () => {
            document.getElementById('complaint-ref-number').textContent = complaintCounter;
        };

        const updateUsernameSuggestion = () => {
            // Only auto-generate if we are adding a new user (no ID yet)
            if (!userIdInput.value) { 
                const name = userNameInput.value.trim();
                const surname = userSurnameInput.value.trim();
                if (name && surname) {
                    userUsernameInput.value = (name + surname.charAt(0)).toLowerCase();
                } else if (name) {
                    userUsernameInput.value = name.toLowerCase();
                } else {
                    userUsernameInput.value = '';
                }
            }
        };


        // --- HANDLERS (Manipulate local mock data) ---
        
        const handleAddItem = () => {
            const categoryKey = document.getElementById('category-selector').value;
            const newItemInput = document.getElementById('new-item-input');
            const newItem = newItemInput.value.trim();
            if (newItem && !(dropdownOptions[categoryKey] || []).includes(newItem)) {
                showConfirmationModal(`Are you sure you want to add "${newItem}"?`, () => {
                    dropdownOptions[categoryKey].push(toSentenceCase(newItem));
                    renderCategoryEditor(categoryKey);
                    updateAllDropdowns();
                    newItemInput.value = '';
                    showSuccessModal('Success', `Successfully added "${newItem}".`);
                });
            }
        };

        const handleDeleteItem = (event) => {
            const deleteButton = event.target.closest('.delete-item-btn');
            if (deleteButton) {
                const categoryKey = document.getElementById('category-selector').value;
                const itemToDelete = deleteButton.dataset.item;
                const itemIndex = parseInt(deleteButton.dataset.index, 10);
                showConfirmationModal(`Are you sure you want to delete "${itemToDelete}"?`, () => {
                    dropdownOptions[categoryKey].splice(itemIndex, 1);
                    renderCategoryEditor(categoryKey);
                    updateAllDropdowns();
                    showSuccessModal('Success', `Successfully deleted "${itemToDelete}".`);
                });
            }
        };

        const handleUserFormSubmit = (e) => {
            e.preventDefault();
            const userId = userIdInput.value;
            
            const newUserData = {
                id: userId ? parseInt(userId, 10) : Date.now(),
                name: userNameInput.value,
                surname: userSurnameInput.value,
                username: userUsernameInput.value,
                email: userEmailInput.value,
                department: userDepartmentSelect.value,
                role: userRoleSelect.value,
            };

            const oldUser = userId ? users.find(u => u.id == userId) : null;
            const roleChanged = !oldUser || oldUser.role !== newUserData.role;
            const action = userId ? 'update' : 'add';

            showConfirmationModal(`Are you sure you want to ${action} this user?`, () => {
                if (action === 'update') {
                    const index = users.findIndex(u => u.id == userId);
                    if (index !== -1) {
                        users[index] = newUserData;
                    }
                } else { // action === 'add'
                    users.push(newUserData);
                    userPermissions[newUserData.id] = { tabs: {} };
                }
                
                renderUsersTable(userSearchInput.value);
                populateLoginDropdown();
                updateAllDropdowns();
                resetUserForm();
                showSuccessModal('Success', `User has been successfully ${action === 'update' ? 'updated' : 'saved'}.`);
            });
        };

        const handleUsersTableClick = (e) => {
            if (e.target.classList.contains('edit-user-btn')) {
                const userId = e.target.dataset.id;
                const user = users.find(u => u.id == userId);
                if (user) {
                    userFormTitle.textContent = 'Edit User';
                    userIdInput.value = user.id;
                    userNameInput.value = user.name;
                    userSurnameInput.value = user.surname;
                    userUsernameInput.value = user.username;
                    userEmailInput.value = user.email;
                    
                    // Set department and then trigger change to populate roles
                    userDepartmentSelect.value = user.department;
                    userDepartmentSelect.dispatchEvent(new Event('change'));
                    
                    // Set role
                    userRoleSelect.value = user.role;
                    
                    userPasswordInput.value = ''; // Clear password field for security
                    userPasswordInput.placeholder = "Unchanged";
                    cancelEditBtn.classList.remove('hidden');
                }
            } else if (e.target.classList.contains('delete-user-btn')) {
                const userId = e.target.dataset.id;
                const user = users.find(u => u.id == userId);
                showConfirmationModal(`Are you sure you want to delete user ${user.name} ${user.surname}?`, () => {
                    users = users.filter(u => u.id != userId);
                    delete userPermissions[userId];
                    renderUsersTable(userSearchInput.value);
                    populateLoginDropdown();
                    updateAllDropdowns();
                    showSuccessModal('Success', 'User has been deleted.');
                });
            }
        };
        
        const savePermissions = () => {
            const selectedUserId = permissionsUserSelect.value;
            if (!selectedUserId) return showSuccessModal('Error', 'Please select a user first.');
            
            showConfirmationModal('Are you sure you want to save these permissions?', () => {
                // The userPermissions object is already up-to-date from the 'change' event listener.
                // In a real app, this is where you would send the userPermissions[selectedUserId] object to your backend.
                showSuccessModal('Success', 'Permissions updated.');
                if (currentUser == selectedUserId) {
                    applyPermissions(); // Re-apply if the current user's permissions changed
                }
            });
        };

        const handlePermissionsUserSearch = (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            const deptSelect = permissionsDeptSelect;
            const roleSelect = permissionsRoleSelect;
            const userSelect = permissionsUserSelect;

            if (searchTerm) {
                deptSelect.disabled = true;
                roleSelect.disabled = true;
                userSelect.disabled = true;

                const foundUser = users.find(u => 
                    u.name.toLowerCase().includes(searchTerm) || 
                    u.surname.toLowerCase().includes(searchTerm) ||
                    u.username.toLowerCase().includes(searchTerm)
                );

                if (foundUser) {
                    // Set department
                    deptSelect.value = foundUser.department;
                    
                    // Update roles for that department
                    const rolesForDept = departmentRoles[foundUser.department] || [];
                    populateDropdown(roleSelect, rolesForDept, 'All Roles');
                    roleSelect.value = foundUser.role;

                    // Update users list (it will just be this one user)
                    populateDropdown(userSelect, [foundUser], 'Select User');
                    userSelect.value = foundUser.id;
                    
                    // Render permissions
                    renderPermissions(foundUser.id);
                    loadRolePermissionsBtn.classList.add('hidden'); // Hide template button during search

                } else {
                    // No user found, clear selections
                    deptSelect.value = '';
                    populateDropdown(roleSelect, [], 'All Roles');
                    populateDropdown(userSelect, [], 'Select User');
                    renderPermissions(null);
                }
            } else {
                // Search is cleared, reset everything
                deptSelect.disabled = false;
                roleSelect.disabled = true; 
                userSelect.disabled = true; 
                
                deptSelect.value = '';
                populateDropdown(roleSelect, [], 'Select Department First');
                populateDropdown(permissionsUserSelect, [], 'Select Role First');

                loadRolePermissionsBtn.classList.add('hidden');
                renderPermissions(null);
            }
        };

       const handleActionClick = (viewId, action) => {
            const view = document.getElementById(viewId);
            const formPanel = view.querySelector('div[id$="-form-panel"]');
            const recordsPanel = view.querySelector('div[id$="-view-records-panel"]');
            const actionButtons = view.querySelector('.flex.justify-center.space-x-4.mb-6');
            
            actionButtons.querySelectorAll('.ob-action-btn').forEach(btn => {
                btn.classList.remove('action-btn-active');
            });
            actionButtons.querySelector(`[data-action="${action}"]`).classList.add('action-btn-active');

            if (action === 'add') {
                formPanel.classList.remove('hidden');
                recordsPanel.classList.add('hidden');
                // You might want to call a reset function for the form here
                 switch(viewId) {
                    case 'ob-entry-view': resetObForm(); break;
                    case 'recoveries-view': resetRecoveryForm(); break;
                    case 'complaints-view': resetComplaintForm(); break;
                    case 'positive-arrests-view': resetArrestForm(); break;
                    case 'sot-view': resetSotForm(); break;
                }
            } else if (action === 'view') {
                formPanel.classList.add('hidden');
                recordsPanel.classList.remove('hidden');
                // Call the appropriate render function
                switch(viewId) {
                    case 'ob-entry-view': renderObRecordsTable(); break;
                    case 'recoveries-view': renderRecoveryRecordsTable(); break;
                    case 'complaints-view': renderComplaintsRecordsTable(); break;
                    case 'positive-arrests-view': renderArrestRecordsTable(); break;
                    case 'sot-view': renderSotRecordsTable(); break;
                }
            }
        };

        const setupActionButtons = (viewId) => {
            const view = document.getElementById(viewId);
            const actionContainer = view.querySelector('.flex.justify-center.space-x-4.mb-6');
            if (!actionContainer) return;
            actionContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.ob-action-btn');
                if (btn) handleActionClick(viewId, btn.dataset.action);
            });
        };
        
        const renderRecoveryRecordsTable = (records = recoveryRecords) => {
            const tbody = document.getElementById('recoveries-records-tbody');
            tbody.innerHTML = '';
             if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">No records found.</td></tr>';
                return;
            }
            records.forEach(record => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="py-2 px-4 border-b text-sm">${record.dateTime ? new Date(record.dateTime).toLocaleString() : 'Invalid Date'}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.name}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.division}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.recoveryType}</td>
                        <td class="py-2 px-4 border-b text-sm">
                            <button data-id="${record.id}" class="edit-recovery-record-btn text-blue-500 hover:underline">Edit</button>
                            <button data-id="${record.id}" class="delete-recovery-record-btn text-red-500 hover:underline ml-2">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        };

        const renderComplaintsRecordsTable = (records = complaintRecords) => {
            const tbody = document.getElementById('complaints-records-tbody');
            tbody.innerHTML = '';
             if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">No records found.</td></tr>';
                return;
            }
            records.forEach(record => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="py-2 px-4 border-b text-sm">${record.refNumber}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.date ? new Date(record.date).toLocaleString() : 'Invalid Date'}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.complainantName}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.status}</td>
                        <td class="py-2 px-4 border-b text-sm">
                            <button data-id="${record.id}" class="edit-complaint-record-btn text-blue-500 hover:underline">Edit</button>
                            <button data-id="${record.id}" class="delete-complaint-record-btn text-red-500 hover:underline ml-2">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        };

        const renderArrestRecordsTable = (records = arrestRecords) => {
            const tbody = document.getElementById('positive-arrests-records-tbody');
            tbody.innerHTML = '';
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">No records found.</td></tr>';
                return;
            }
            records.forEach(record => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="py-2 px-4 border-b text-sm">${record.date ? new Date(record.date).toLocaleDateString() : 'Invalid Date'}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.division}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.addressOfCrime}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.totalSuspects}</td>
                        <td class="py-2 px-4 border-b text-sm">
                            <button data-id="${record.id}" class="edit-arrest-record-btn text-blue-500 hover:underline">Edit</button>
                            <button data-id="${record.id}" class="delete-arrest-record-btn text-red-500 hover:underline ml-2">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        };

        const renderSotRecordsTable = (records = sotRecords) => {
             const tbody = document.getElementById('sot-records-tbody');
            tbody.innerHTML = '';
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">No records found.</td></tr>';
                return;
            }
            records.forEach(record => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="py-2 px-4 border-b text-sm">${record.dateOpened ? new Date(record.dateOpened).toLocaleString() : 'Invalid Date'}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.marshallClient}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.incidentType}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.status}</td>
                        <td class="py-2 px-4 border-b text-sm">
                            <button data-id="${record.id}" class="edit-sot-record-btn text-blue-500 hover:underline">Edit</button>
                            <button data-id="${record.id}" class="delete-sot-record-btn text-red-500 hover:underline ml-2">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        };

        const resetObForm = () => {
            document.getElementById('ob-form').reset();
            document.getElementById('ob-record-id').value = '';
            document.getElementById('ob-number-display').textContent = obCounter;
            document.getElementById('created-date').textContent = currentDate.toLocaleString();
            document.getElementById('ob-form-title').textContent = 'Add Occurrence Book Record';
        };

        const resetRecoveryForm = () => {
             document.getElementById('recoveries-form').reset();
             document.getElementById('recovery-record-id').value = '';
             document.getElementById('recovery-form-title').textContent = 'Recoveries';
        };

        const resetComplaintForm = () => {
             document.getElementById('complaints-form').reset();
             document.getElementById('complaint-record-id').value = '';
             document.getElementById('complaint-form-title').textContent = 'Complaints';
             updateComplaintRefNumber();
        };

         const resetArrestForm = () => {
             document.getElementById('positive-arrests-form').reset();
             document.getElementById('arrest-record-id').value = '';
             document.getElementById('arrest-form-title').textContent = 'Positive Arrests';
             document.getElementById('suspects-tbody').innerHTML = '';
        };
        
        const resetSotForm = () => {
            const form = document.getElementById('sot-form');
            form.reset();
            document.getElementById('sot-record-id').value = '';
            document.getElementById('sot-form-title').textContent = 'SOT Positives';
            // Also hide all comment textareas
            form.querySelectorAll('.sot-comment-toggle').forEach(checkbox => {
                const targetId = checkbox.dataset.target;
                const textarea = document.getElementById(targetId);
                if (textarea) {
                    textarea.classList.add('hidden');
                }
            });
        };
        
        const renderObRecordsTable = (records = obRecords) => {
            const tbody = document.getElementById('ob-records-tbody');
            tbody.innerHTML = '';
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center p-4">No records found.</td></tr>';
                return;
            }
            records.forEach(record => {
                const address = [record.address1, record.address2, record.address3].filter(Boolean).join(', ');
                const incidentTime = `From: ${new Date(record.timeFrom).toLocaleString()} <br> To: ${new Date(record.timeTo).toLocaleString()}`;

                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="py-2 px-4 border-b text-sm">${record.obNumber}</td>
                        <td class="py-2 px-4 border-b text-sm">${new Date(record.created).toLocaleDateString()}</td>
                        <td class="py-2 px-4 border-b text-sm">${incidentTime}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.obType}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.clientAccount || ''}</td>
                        <td class="py-2 px-4 border-b text-sm">${address}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.area}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.comments || ''}</td>
                        <td class="py-2 px-4 border-b text-sm">${record.status}</td>
                        <td class="py-2 px-4 border-b text-sm">
                            <button data-id="${record.id}" class="edit-ob-record-btn text-blue-500 hover:underline">Edit</button>
                            <button data-id="${record.id}" class="delete-ob-record-btn text-red-500 hover:underline ml-2">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        };

        const handleObSearch = () => {
            const dateFromValue = document.getElementById('ob-search-date-from').value;
            const dateToValue = document.getElementById('ob-search-date-to').value;
            const type = document.getElementById('ob-search-type').value;
            const station = document.getElementById('ob-search-station').value;
            const cas = document.getElementById('ob-search-cas').value.toLowerCase().trim();
            const sap = document.getElementById('ob-search-sap').value.toLowerCase().trim();
            const area = document.getElementById('ob-search-area').value;
            const client = document.getElementById('ob-search-client').value.toLowerCase().trim();
            const contact = document.getElementById('ob-search-contact').value.trim();
            const address = document.getElementById('ob-search-address').value.toLowerCase().trim();

            const filteredRecords = obRecords.filter(record => {
                const recordDate = new Date(record.created);
                recordDate.setHours(0, 0, 0, 0);

                let dateMatch = true;
                if (dateFromValue) {
                    const parts = dateFromValue.split('-');
                    const fromDate = new Date(parts[0], parts[1] - 1, parts[2]);
                    if (recordDate < fromDate) {
                        dateMatch = false;
                    }
                }
                if (dateToValue) {
                    const parts = dateToValue.split('-');
                    const toDate = new Date(parts[0], parts[1] - 1, parts[2]);
                    if (recordDate > toDate) {
                        dateMatch = false;
                    }
                }
                
                const fullAddress = `${record.address1 || ''} ${record.address2 || ''} ${record.address3 || ''}`.toLowerCase().trim();

                return dateMatch &&
                    (!type || record.obType === type) &&
                    (!station || record.policeStation === station) &&
                    (!cas || record.casNumber?.toLowerCase().includes(cas)) &&
                    (!sap || record.sapNumber?.toLowerCase().includes(sap)) &&
                    (!area || record.area === area) &&
                    (!client || record.clientAccount?.toLowerCase().includes(client)) &&
                    (!contact || record.contactNo?.includes(contact)) &&
                    (!address || fullAddress.includes(address));
            });
            renderObRecordsTable(filteredRecords);
        };

        const loadObRecordIntoForm = (recordId) => {
            const record = obRecords.find(r => r.id == recordId);
            if (!record) return;

            handleActionClick('ob-entry-view', 'add');
            document.getElementById('ob-form-title').textContent = `Update OB Record #${record.obNumber}`;

            document.getElementById('ob-record-id').value = record.id;
            document.getElementById('ob-number-display').textContent = record.obNumber;
            document.getElementById('created-date').textContent = new Date(record.created).toLocaleString();
            document.getElementById('ob-time-from').value = record.timeFrom;
            document.getElementById('ob-time-to').value = record.timeTo;
            document.getElementById('ob-type-select').value = record.obType;
            document.getElementById('ob-category').value = record.obCategory;
            document.getElementById('police-station-select').value = record.policeStation;
            document.getElementById('ob-cas-number').value = record.casNumber;
            
            const sapContainer = document.querySelector('#ob-form .sap-container');
            if (sapContainer && record.sapNumber) {
                const parts = record.sapNumber.split('/');
                if (parts.length === 3) {
                    sapContainer.querySelector('input').value = parts[0];
                    sapContainer.querySelector('.sap-month').value = parts[1];
                    sapContainer.querySelector('.sap-year').value = parts[2];
                } else {
                     sapContainer.querySelector('input').value = record.sapNumber;
                }
            }


            document.getElementById('ob-requires-followup').checked = record.requiresFollowup || false;
            document.getElementById('follow-up-user-select').value = record.followUpUser || '';
            document.getElementById('area-select').value = record.area;
            document.getElementById('ob-client-account').value = record.clientAccount;
            document.getElementById('ob-contact-no').value = record.contactNo;
            document.getElementById('ob-address1').value = record.address1 || '';
            document.getElementById('ob-address2').value = record.address2 || '';
            document.getElementById('ob-address3').value = record.address3 || '';
            document.getElementById('ob-lat').value = record.lat || '';
            document.getElementById('ob-lon').value = record.lon || '';
            document.getElementById('ob-comments').value = record.comments || '';

            const statusButtons = document.getElementById('status-buttons');
            statusButtons.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('status-btn-active');
                if (btn.dataset.status === record.status) {
                    btn.classList.add('status-btn-active');
                }
            });
        };

        const handleSaveObRecord = () => {
            const recordId = document.getElementById('ob-record-id').value;
            const action = recordId ? 'update' : 'add';

            const sapContainer = document.querySelector('#ob-form .sap-container');
            const sapNumber = sapContainer.querySelector('input').value;
            const sapMonth = sapContainer.querySelector('.sap-month').value;
            const sapYear = sapContainer.querySelector('.sap-year').value;
            const fullSap = (sapNumber && sapMonth && sapYear) ? `${sapNumber}/${sapMonth}/${sapYear}` : sapNumber;


            let recordData = {
                id: recordId ? parseInt(recordId) : Date.now(),
                obNumber: recordId ? obRecords.find(r => r.id == recordId).obNumber : obCounter,
                created: recordId ? obRecords.find(r => r.id == recordId).created : currentDate.toISOString(),
                createdBy: createdByUserSpan.textContent,
                timeFrom: document.getElementById('ob-time-from').value,
                timeTo: document.getElementById('ob-time-to').value,
                obType: document.getElementById('ob-type-select').value,
                obCategory: document.getElementById('ob-category').value,
                policeStation: document.getElementById('police-station-select').value,
                casNumber: document.getElementById('ob-cas-number').value,
                sapNumber: fullSap,
                requiresFollowup: document.getElementById('ob-requires-followup').checked,
                followUpUser: document.getElementById('follow-up-user-select').value,
                area: document.getElementById('area-select').value,
                clientAccount: document.getElementById('ob-client-account').value,
                contactNo: document.getElementById('ob-contact-no').value,
                address1: document.getElementById('ob-address1').value,
                address2: document.getElementById('ob-address2').value,
                address3: document.getElementById('ob-address3').value,
                lat: document.getElementById('ob-lat').value,
                lon: document.getElementById('ob-lon').value,
                comments: document.getElementById('ob-comments').value,
                status: document.querySelector('#status-buttons .status-btn-active').dataset.status
            };

            if (!recordData.obType) {
                showSuccessModal('Error', 'OB Type is a required field.');
                return;
            }

            showConfirmationModal(`Are you sure you want to ${action} this record?`, () => {
                if (action === 'add') {
                    obRecords.push(recordData);
                    obCounter++;
                } else {
                    const index = obRecords.findIndex(r => r.id == recordId);
                    if (index !== -1) {
                        obRecords[index] = recordData;
                    }
                }
                showSuccessModal('Success', `Record successfully ${action === 'add' ? 'saved' : 'updated'}.`);
                resetObForm();
                 const actionContainer = document.getElementById('ob-actions');
                const addBtn = actionContainer.querySelector('[data-action="add"]');
                if (addBtn) addBtn.click();
            });
        };

        // --- DEPARTMENT & ROLE MANAGEMENT ---

        const renderDepartments = () => {
            departmentList.innerHTML = '';
            dropdownOptions.department.forEach(dept => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center p-2 bg-white rounded-md shadow-sm';
                itemDiv.innerHTML = `
                    <span class="flex-grow">${dept}</span>
                    <button data-dept="${dept}" class="delete-dept-btn text-red-500 hover:text-red-700 font-bold p-1">X</button>
                `;
                departmentList.appendChild(itemDiv);
            });
            updateAllDropdowns(); // Update dropdowns across the app
        };

        const renderRoles = () => {
            roleList.innerHTML = '';
            dropdownOptions.role.forEach(role => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center p-2 bg-white rounded-md shadow-sm';
                itemDiv.innerHTML = `
                    <span class="flex-grow">${role}</span>
                    <button data-role="${role}" class="delete-role-btn text-red-500 hover:text-red-700 font-bold p-1">X</button>
                `;
                roleList.appendChild(itemDiv);
            });
            renderRoleAssignments();
        };

        const renderRoleAssignments = () => {
            const selectedDept = assignDeptSelect.value;
            roleAssignmentList.innerHTML = '';
            if (!selectedDept) {
                roleAssignmentList.innerHTML = `<p class="text-gray-500">Please select a department to see roles.</p>`;
                return;
            }

            const assignedRoles = departmentRoles[selectedDept] || [];
            dropdownOptions.role.forEach(role => {
                const isChecked = assignedRoles.includes(role);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center p-2';
                itemDiv.innerHTML = `
                    <input type="checkbox" id="role-assign-${role.replace(/\s+/g, '-')}" data-role="${role}" class="h-4 w-4" ${isChecked ? 'checked' : ''}>
                    <label for="role-assign-${role.replace(/\s+/g, '-')}" class="ml-3 text-sm text-gray-700">${role}</label>
                `;
                roleAssignmentList.appendChild(itemDiv);
            });
        };
        
        // --- EVENT LISTENERS ---
        const addEventListeners = () => {
            document.getElementById('modal-cancel-btn').addEventListener('click', () => confirmModal.style.display = 'none');
            successModalOkBtn.addEventListener('click', () => successModal.style.display = 'none');
            
            loginAsSelect.addEventListener('change', (e) => {
                currentUser = e.target.value;
                applyPermissions();
                updateCreatedBy();
            });

            sidebarNav.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-view]');
                if (btn && !btn.classList.contains('hidden')) {
                    sidebarNav.querySelectorAll('button').forEach(b => {
                        b.classList.remove('active-btn', 'bg-blue-500', 'text-white');
                        b.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    btn.classList.add('active-btn', 'bg-blue-500', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    showView(btn.dataset.view);
                }
            });
            
            const categorySelectorElem = document.getElementById('category-selector');
            categorySelectorElem.addEventListener('change', () => renderCategoryEditor(categorySelectorElem.value));
            document.getElementById('add-item-btn').addEventListener('click', handleAddItem);
            document.getElementById('new-item-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddItem(); });
            document.getElementById('category-item-list').addEventListener('click', handleDeleteItem);

            userSearchInput.addEventListener('input', (e) => {
                renderUsersTable(e.target.value);
            });

            userForm.addEventListener('submit', handleUserFormSubmit);
            usersTbody.addEventListener('click', handleUsersTableClick);
            cancelEditBtn.addEventListener('click', resetUserForm);

            // --- USERNAME SUGGESTION LOGIC ---
            userNameInput.addEventListener('input', updateUsernameSuggestion);
            userSurnameInput.addEventListener('input', updateUsernameSuggestion);


            // --- LINKED DROPDOWNS LOGIC & PERMISSION TEMPLATE BUTTON ---
            userDepartmentSelect.addEventListener('change', (e) => {
                const selectedDept = e.target.value;
                const rolesForDept = selectedDept ? departmentRoles[selectedDept] : [];
                populateDropdown(userRoleSelect, rolesForDept, 'Select Role');
            });

            permissionsDeptSelect.addEventListener('change', () => {
                const selectedDept = permissionsDeptSelect.value;
                const rolesForDept = selectedDept ? (departmentRoles[selectedDept] || []) : [];
                populateDropdown(permissionsRoleSelect, rolesForDept, 'Select Role');
                populateDropdown(permissionsUserSelect, [], 'Select Role First'); // Clear users
                
                permissionsRoleSelect.disabled = !selectedDept;
                permissionsUserSelect.disabled = true;

                renderPermissions(null); // Clear permissions table
                loadRolePermissionsBtn.classList.add('hidden');
            });

            permissionsRoleSelect.addEventListener('change', () => {
                const selectedDept = permissionsDeptSelect.value;
                const selectedRole = permissionsRoleSelect.value;

                const filteredUsers = (selectedDept && selectedRole) 
                    ? users.filter(u => u.department === selectedDept && u.role === selectedRole)
                    : [];
                populateDropdown(permissionsUserSelect, filteredUsers, 'Select User');
                
                permissionsUserSelect.disabled = !selectedRole;

                renderPermissions(null); // Clear permissions table

                const showButton = selectedRole && rolePermissions[selectedRole];
                loadRolePermissionsBtn.classList.toggle('hidden', !showButton);
            });

            loadRolePermissionsBtn.addEventListener('click', () => {
                const selectedRole = permissionsRoleSelect.value;
                const selectedUserId = permissionsUserSelect.value;
                const selectedUser = users.find(u => u.id == selectedUserId);

                if (!selectedRole || !rolePermissions[selectedRole]) {
                    showSuccessModal('Error', 'A valid role with a permission template must be selected.');
                    return;
                }
                if (!selectedUserId || !selectedUser) {
                    showSuccessModal('Error', 'Please select a user first before loading a template.');
                    return;
                }
                const message = `This will overwrite the current permissions for ${selectedUser.name} ${selectedUser.surname} with the default template for the "${selectedRole}" role. Are you sure?`;
                showConfirmationModal(message, () => {
                    userPermissions[selectedUserId] = JSON.parse(JSON.stringify(rolePermissions[selectedRole]));
                    renderPermissions(selectedUserId);
                    showSuccessModal('Success', `Default permissions for "${selectedRole}" have been loaded. Please review and click Save Permissions.`);
                });
            });
            
            permissionsUserSearchInput.addEventListener('input', handlePermissionsUserSearch);
            permissionsUserSelect.addEventListener('change', e => renderPermissions(e.target.value));
            savePermissionsBtn.addEventListener('click', savePermissions);
            permissionsContainer.addEventListener('change', handlePermissionChange);

            document.getElementById('save-complaint-btn').addEventListener('click', handleSaveComplaintRecord);
            document.getElementById('save-recovery-btn').addEventListener('click', handleSaveRecoveryRecord);
            document.getElementById('save-arrest-btn').addEventListener('click', handleSaveArrestRecord);
            document.getElementById('save-sot-btn').addEventListener('click', handleSaveSotRecord);


             // Generic Status Button Click Handler
            const handleStatusButtonClick = (e) => {
                const btn = e.target.closest('.status-btn');
                if (btn) {
                    const container = btn.parentElement;
                    container.querySelectorAll('.status-btn').forEach(b => b.classList.remove('status-btn-active'));
                    btn.classList.add('status-btn-active');
                    
                    // Special handling for complaints view
                    if(container.id === 'complaint-status-buttons'){
                         const resolutionContainer = document.getElementById('complaint-resolution-container');
                         const isResolved = btn.dataset.status === 'Resolved';
                         resolutionContainer.classList.toggle('hidden', !isResolved);
                         resolutionContainer.classList.toggle('flex', isResolved);
                    }
                }
            };

            ['status-buttons', 'complaint-status-buttons', 'sot-status-buttons'].forEach(id => {
                document.getElementById(id)?.addEventListener('click', handleStatusButtonClick);
            });


            // Set up action button handlers for all views
            ['ob-entry-view', 'recoveries-view', 'complaints-view', 'positive-arrests-view', 'sot-view'].forEach(setupActionButtons);


            document.getElementById('save-record-btn').addEventListener('click', handleSaveObRecord);
            

            document.getElementById('ob-search-btn').addEventListener('click', handleObSearch);
            document.getElementById('ob-clear-search-btn').addEventListener('click', () => {
                document.getElementById('ob-search-form').reset();
                renderObRecordsTable(obRecords);
            });
             document.getElementById('ob-records-tbody').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-ob-record-btn')) {
                    const recordId = e.target.dataset.id;
                    loadObRecordIntoForm(recordId);
                } else if (e.target.classList.contains('delete-ob-record-btn')) {
                     const recordId = e.target.dataset.id;
                     const record = obRecords.find(r => r.id == recordId);
                     showConfirmationModal(`Are you sure you want to delete OB Record #${record.obNumber}?`, () => {
                         obRecords = obRecords.filter(r => r.id != recordId);
                         renderObRecordsTable();
                         showSuccessModal('Success', 'Record deleted.');
                     });
                }
            });

             // --- CORRECTED EVENT LISTENERS FOR ALL OTHER TABLES ---
            document.getElementById('recoveries-records-tbody').addEventListener('click', (e) => {
                const recordId = e.target.dataset.id;
                if (e.target.classList.contains('edit-recovery-record-btn')) {
                    window.loadRecoveryRecordIntoForm(recordId);
                } else if (e.target.classList.contains('delete-recovery-record-btn')) {
                    window.handleDeleteRecoveryRecord(recordId);
                }
            });

            document.getElementById('complaints-records-tbody').addEventListener('click', (e) => {
                const recordId = e.target.dataset.id;
                if (e.target.classList.contains('edit-complaint-record-btn')) {
                    window.loadComplaintRecordIntoForm(recordId);
                } else if (e.target.classList.contains('delete-complaint-record-btn')) {
                    window.handleDeleteComplaintRecord(recordId);
                }
            });

            document.getElementById('positive-arrests-records-tbody').addEventListener('click', (e) => {
                const recordId = e.target.dataset.id;
                if (e.target.classList.contains('edit-arrest-record-btn')) {
                    window.loadPositiveArrestRecordIntoForm(recordId);
                } else if (e.target.classList.contains('delete-arrest-record-btn')) {
                    window.handleDeletePositiveArrestRecord(recordId);
                }
            });

            document.getElementById('sot-records-tbody').addEventListener('click', (e) => {
                const recordId = e.target.dataset.id;
                if (e.target.classList.contains('edit-sot-record-btn')) {
                    window.loadSotRecordIntoForm(recordId);
                } else if (e.target.classList.contains('delete-sot-record-btn')) {
                    window.handleDeleteSotRecord(recordId);
                }
            });


            // Suspect add/remove
            document.getElementById('add-suspect-btn').addEventListener('click', () => {
                const tbody = document.getElementById('suspects-tbody');
                const newRow = document.createElement('tr');
                newRow.className = 'suspect-row';
                newRow.innerHTML = `
                    <td class="py-2 px-4 border-b"><input type="text" class="p-1 border rounded-md w-full suspect-name" placeholder="Name & Surname"></td>
                    <td class="py-2 px-4 border-b"><input type="text" class="p-1 border rounded-md w-full suspect-id" placeholder="ID Number"></td>
                    <td class="py-2 px-4 border-b"><input type="file" class="p-1 border rounded-md w-full suspect-id-pic"></td>
                    <td class="py-2 px-4 border-b"><button type="button" class="remove-suspect-btn text-red-500 hover:underline">Remove</button></td>
                `;
                tbody.appendChild(newRow);
            });

            document.getElementById('suspects-tbody').addEventListener('click', e => {
                if (e.target.classList.contains('remove-suspect-btn')) {
                    e.target.closest('tr').remove();
                }
            });
            
            // SOT Comment Toggles
            document.getElementById('sot-comments-section').addEventListener('change', e => {
                if (e.target.classList.contains('sot-comment-toggle')) {
                    const targetId = e.target.dataset.target;
                    const textarea = document.getElementById(targetId);
                    if (textarea) {
                        textarea.classList.toggle('hidden', !e.target.checked);
                    }
                }
            });
            
            // Textarea autosize
            document.body.addEventListener('input', e => {
                if(e.target.tagName.toLowerCase() === 'textarea' && e.target.classList.contains('autosize-textarea')) {
                    e.target.style.height = 'auto';
                    e.target.style.height = (e.target.scrollHeight) + 'px';
                }
            });
            
            // Input formatters
            document.body.addEventListener('input', e => {
                 if (e.target.classList.contains('numeric-only')) {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                } else if(e.target.classList.contains('decimal-only')) {
                     e.target.value = e.target.value.replace(/[^0-9.-]/g, '');
                } else if (e.target.classList.contains('currency-rand')) {
                    let value = e.target.value.replace(/[^0-9.]/g, '');
                    const parts = value.split('.');
                    if (parts.length > 2) {
                        value = parts[0] + '.' + parts.slice(1).join('');
                    }
                    if (parts[1] && parts[1].length > 2) {
                        parts[1] = parts[1].substring(0, 2);
                        value = parts.join('.');
                    }
                    e.target.value = value;
                }
            });

            document.body.addEventListener('blur', e => {
                if (e.target.classList.contains('currency-rand') && e.target.value) {
                    const value = parseFloat(e.target.value);
                    if (!isNaN(value)) {
                         e.target.value = 'R ' + value.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                }
            }, true);

            document.body.addEventListener('focus', e => {
                if (e.target.classList.contains('currency-rand')) {
                   e.target.value = e.target.value.replace(/[R\s,]/g, '');
                }
            }, true);


            addDepartmentForm.addEventListener('submit', e => {
                e.preventDefault();
                const newDept = toSentenceCase(newDepartmentInput.value.trim());
                if (newDept && !departmentRoles[newDept]) {
                    departmentRoles[newDept] = [];
                    dropdownOptions.department = Object.keys(departmentRoles);
                    renderDepartments();
                    newDepartmentInput.value = '';
                    showSuccessModal('Success', `Department "${newDept}" added.`);
                } else {
                     showSuccessModal('Error', `Department "${newDept}" already exists or is invalid.`);
                }
            });

            addRoleForm.addEventListener('submit', e => {
                e.preventDefault();
                const newRole = toSentenceCase(newRoleInput.value.trim());
                if (newRole && !dropdownOptions.role.includes(newRole)) {
                    dropdownOptions.role.push(newRole);
                    renderRoles();
                    newRoleInput.value = '';
                    showSuccessModal('Success', `Role "${newRole}" added.`);
                } else {
                    showSuccessModal('Error', `Role "${newRole}" already exists or is invalid.`);
                }
            });

            saveAssignmentBtn.addEventListener('click', () => {
                const selectedDept = assignDeptSelect.value;
                if (!selectedDept) {
                    showSuccessModal('Error', 'Please select a department first.');
                    return;
                }
                showConfirmationModal(`Are you sure you want to save role assignments for ${selectedDept}?`, () => {
                    const newAssignedRoles = [];
                    roleAssignmentList.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                        newAssignedRoles.push(cb.dataset.role);
                    });
                    departmentRoles[selectedDept] = newAssignedRoles;
                    showSuccessModal('Success', `Assignments for ${selectedDept} saved.`);
                });
            });

            departmentList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-dept-btn')) {
                    const deptToDelete = e.target.dataset.dept;
                    showConfirmationModal(`Are you sure you want to delete the "${deptToDelete}" department? This cannot be undone.`, () => {
                        delete departmentRoles[deptToDelete];
                        dropdownOptions.department = Object.keys(departmentRoles);
                        renderDepartments();
                        renderRoleAssignments();
                        showSuccessModal('Success', `Department "${deptToDelete}" deleted.`);
                    });
                }
            });
            
            roleList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-role-btn')) {
                    const roleToDelete = e.target.dataset.role;
                     showConfirmationModal(`Are you sure you want to delete the "${roleToDelete}" role? This will remove it from all departments.`, () => {
                        // Remove from flat list
                        dropdownOptions.role = dropdownOptions.role.filter(r => r !== roleToDelete);
                        // Remove from all department assignments
                        for (const dept in departmentRoles) {
                            departmentRoles[dept] = departmentRoles[dept].filter(r => r !== roleToDelete);
                        }
                        renderRoles();
                        showSuccessModal('Success', `Role "${roleToDelete}" deleted.`);
                    });
                }
            });

            assignDeptSelect.addEventListener('change', renderRoleAssignments);

        };
        
        // --- INITIALIZATION ---
        const initApp = () => {
            confirmModal.style.display = 'none';
            successModal.style.display = 'none';

            addEventListeners();
            renderPermissionsTable();
            
            // Populate all SAPS 13 number fields
            const sapContainers = document.querySelectorAll('.sap-container');
            sapContainers.forEach(container => {
                const monthSelect = container.querySelector('.sap-month');
                const yearSelect = container.querySelector('.sap-year');
                const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                months.forEach(month => {
                    monthSelect.innerHTML += `<option value="${month}">${month}</option>`;
                });
                const currentYear = new Date().getFullYear();
                for (let i = -5; i < 5; i++) {
                    const year = currentYear + i;
                    yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                }
                yearSelect.value = currentYear;
            });
            
            // Set initial dates
            document.getElementById('created-date').textContent = currentDate.toLocaleString();
            document.getElementById('ob-search-date-from').value = '2025-10-01';
            document.getElementById('ob-search-date-to').value = '2025-10-14';

            // Dynamically populate the category selector dropdown
            const categorySelector = document.getElementById('category-selector');
            Object.keys(dropdownOptions).forEach(key => {
                const textLabel = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                const option = new Option(textLabel, key);
                categorySelector.add(option);
            });

            // Load all data from mock objects
            renderUsersTable();
            populateLoginDropdown();
            updateAllDropdowns();
            renderDepartments();
            renderRoles();
            applyPermissions(); 
            renderCategoryEditor(document.getElementById('category-selector').value);
            
            // Set initial view
            const firstVisibleButton = sidebarNav.querySelector('button[data-view]:not(.hidden)');
            if (firstVisibleButton) {
                firstVisibleButton.click();
            } else {
                showView(null); 
            }
        };

        // --- FULLY IMPLEMENTED HANDLERS FOR EDIT/DELETE ---

        window.loadRecoveryRecordIntoForm = (recordId) => { 
            const record = recoveryRecords.find(r => r.id == recordId);
            if (!record) return;
            handleActionClick('recoveries-view', 'add');
            document.getElementById('recovery-form-title').textContent = `Update Recovery Record`;
            document.getElementById('recovery-record-id').value = record.id;
             for (const key in record) {
                const element = document.getElementById(`recovery-${key.replace(/([A-Z])/g, (g) => `-${g[0].toLowerCase()}`)}`);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = record[key];
                    } else {
                        element.value = record[key] || '';
                    }
                }
            }
        };

        window.loadComplaintRecordIntoForm = (recordId) => { 
             const record = complaintRecords.find(r => r.id == recordId);
            if (!record) return;
            handleActionClick('complaints-view', 'add');
            document.getElementById('complaint-form-title').textContent = `Update Complaint #${record.refNumber}`;
            document.getElementById('complaint-record-id').value = record.id;
            document.getElementById('complaint-ref-number').textContent = record.refNumber;
            document.getElementById('complaint-date').value = record.date;
            document.getElementById('complaint-name').value = record.complainantName;
            document.getElementById('complaint-contact').value = record.contact;
            document.getElementById('complaint-email').value = record.email;
            document.getElementById('complaint-department-select').value = record.department;
            document.getElementById('complaint-user-select').value = record.user;
            document.getElementById('complaint-nature-select').value = record.nature;
            document.getElementById('complaint-details').value = record.details;
            document.getElementById('complaint-assigned-select').value = record.assignedTo;
            document.getElementById('complaint-resolution').value = record.resolution;
            document.getElementById('complaint-status-buttons').querySelector(`[data-status="${record.status}"]`).click();
        };

        window.loadPositiveArrestRecordIntoForm = (recordId) => { 
            const record = arrestRecords.find(r => r.id == recordId);
            if (!record) return;
            handleActionClick('positive-arrests-view', 'add');
            document.getElementById('arrest-form-title').textContent = `Update Arrest Record`;
            document.getElementById('arrest-record-id').value = record.id;
            document.getElementById('arrest-datetime-captured').value = record.dateTimeCaptured;
            document.getElementById('arrest-entered-by').value = record.enteredBy;
            document.getElementById('pa-division-select').value = record.division;
            document.getElementById('arrest-date').value = record.date;
            document.getElementById('arrest-address').value = record.addressOfCrime;
            document.getElementById('arrest-total-suspects').value = record.totalSuspects;
            document.getElementById('arrest-arrested-by').value = record.arrestedBy;
        };
        
        window.loadSotRecordIntoForm = (recordId) => { 
            const record = sotRecords.find(r => r.id == recordId);
            if (!record) return;
            handleActionClick('sot-view', 'add');
            document.getElementById('sot-form-title').textContent = `Update SOT Record`;
            document.getElementById('sot-record-id').value = record.id;
            document.getElementById('sot-date-opened').value = record.dateOpened;
            document.getElementById('sot-date-assigned').value = record.dateAssigned;
            document.getElementById('sot-date-closed').value = record.dateClosed;
            document.getElementById('sot-date-investigation-closed').value = record.investigationCloseDate;
            document.getElementById('sot-client').value = record.marshallClient;
            document.getElementById('sot-unit-number').value = record.unitNumber;
            document.getElementById('sot-business-name').value = record.businessName;
            document.getElementById('sot-incident-type-select').value = record.incidentType;
            document.getElementById('sot-person-assigned-select').value = record.personAssigned;
            document.getElementById('sot-client-contacted').checked = record.clientContacted;
            document.getElementById('sot-contact-number').value = record.contactNumber;
            document.getElementById('sot-onsite-meeting').checked = record.onsiteMeeting;
            document.getElementById('sot-address').value = record.address;
            document.getElementById('sot-feedback').value = record.feedback;
            document.getElementById('sot-status-buttons').querySelector(`[data-status="${record.status}"]`).click();
        };


        const handleSaveRecoveryRecord = () => {
             const recordId = document.getElementById('recovery-record-id').value;
             const action = recordId ? 'update' : 'add';
             const recordData = {
                id: recordId ? parseInt(recordId, 10) : Date.now(),
                dateTime: document.getElementById('recovery-datetime').value,
                name: document.getElementById('recovery-name').value,
                division: document.getElementById('recovery-division-select').value,
                recoveryType: document.getElementById('recovery-type-select').value,
                incidentType: document.getElementById('recovery-incident-type-select').value,
                duration: document.getElementById('recovery-duration').value,
                registration: document.getElementById('recovery-registration').value,
                vin: document.getElementById('recovery-vin').value,
                items: document.getElementById('recovery-items').value,
                quantity: document.getElementById('recovery-quantity').value,
                vehicleBrand: document.getElementById('recovery-vehicle-brand-select').value,
                make: document.getElementById('recovery-make').value,
                psFrom: document.getElementById('recovery-ps-from-select').value,
                caseNumber: document.getElementById('recovery-case-number').value,
                psRecovered: document.getElementById('recovery-ps-recovered-select').value,
                valueVehicle: document.getElementById('recovery-value-vehicle').value,
                valueItems: document.getElementById('recovery-value-items').value,
                address: document.getElementById('recovery-address').value,
                lat: document.getElementById('recovery-lat').value,
                lon: document.getElementById('recovery-lon').value,
                obNumber: document.getElementById('recovery-ob-number').value,
                recoveredBy: document.getElementById('recovery-recovered-by').value,
             };
             showConfirmationModal(`Are you sure you want to ${action} this recovery?`, () => {
                if (action === 'add') {
                    recoveryRecords.push(recordData);
                } else {
                    const index = recoveryRecords.findIndex(r => r.id == recordId);
                    if (index !== -1) recoveryRecords[index] = recordData;
                }
                resetRecoveryForm();
                showSuccessModal('Success', `Recovery record ${action === 'add' ? 'saved' : 'updated'}.`);
                renderRecoveryRecordsTable();
            });
        };
        const handleSaveComplaintRecord = () => {
            const recordId = document.getElementById('complaint-record-id').value;
            const action = recordId ? 'update' : 'add';
            const recordData = {
                id: recordId ? parseInt(recordId, 10) : Date.now(),
                refNumber: recordId ? complaintRecords.find(c => c.id == recordId).refNumber : complaintCounter,
                date: document.getElementById('complaint-date').value,
                complainantName: document.getElementById('complaint-name').value,
                contact: document.getElementById('complaint-contact').value,
                email: document.getElementById('complaint-email').value,
                department: document.getElementById('complaint-department-select').value,
                user: document.getElementById('complaint-user-select').value,
                nature: document.getElementById('complaint-nature-select').value,
                details: document.getElementById('complaint-details').value,
                assignedTo: document.getElementById('complaint-assigned-select').value,
                resolution: document.getElementById('complaint-resolution').value,
                status: document.querySelector('#complaint-status-buttons .status-btn-active').dataset.status
             };
             showConfirmationModal(`Are you sure you want to ${action} this complaint?`, () => {
                if (action === 'add') {
                    complaintRecords.push(recordData);
                    complaintCounter++;
                } else {
                    const index = complaintRecords.findIndex(c => c.id == recordId);
                    if (index !== -1) complaintRecords[index] = recordData;
                }
                resetComplaintForm();
                showSuccessModal('Success', `Complaint has been ${action === 'add' ? 'saved' : 'updated'}.`);
                renderComplaintsRecordsTable();
            });
        };
        const handleSaveArrestRecord = () => {
             const recordId = document.getElementById('arrest-record-id').value;
             const action = recordId ? 'update' : 'add';
             const recordData = {
                 id: recordId ? parseInt(recordId, 10) : Date.now(),
                 dateTimeCaptured: document.getElementById('arrest-datetime-captured').value,
                 enteredBy: document.getElementById('arrest-entered-by').value,
                 division: document.getElementById('pa-division-select').value,
                 date: document.getElementById('arrest-date').value,
                 addressOfCrime: document.getElementById('arrest-address').value,
                 totalSuspects: document.getElementById('arrest-total-suspects').value,
                 arrestedBy: document.getElementById('arrest-arrested-by').value,
             };
             showConfirmationModal(`Are you sure you want to ${action} this arrest?`, () => {
                if (action === 'add') {
                    arrestRecords.push(recordData);
                } else {
                    const index = arrestRecords.findIndex(r => r.id == recordId);
                    if (index !== -1) arrestRecords[index] = recordData;
                }
                resetArrestForm();
                showSuccessModal('Success', `Arrest record ${action === 'add' ? 'saved' : 'updated'}.`);
                renderArrestRecordsTable();
            });
        };
        const handleSaveSotRecord = () => {
             const recordId = document.getElementById('sot-record-id').value;
             const action = recordId ? 'update' : 'add';
             const recordData = {
                 id: recordId ? parseInt(recordId, 10) : Date.now(),
                 dateOpened: document.getElementById('sot-date-opened').value,
                 dateAssigned: document.getElementById('sot-date-assigned').value,
                 dateClosed: document.getElementById('sot-date-closed').value,
                 investigationCloseDate: document.getElementById('sot-date-investigation-closed').value,
                 marshallClient: document.getElementById('sot-client').value,
                 unitNumber: document.getElementById('sot-unit-number').value,
                 businessName: document.getElementById('sot-business-name').value,
                 incidentType: document.getElementById('sot-incident-type-select').value,
                 personAssigned: document.getElementById('sot-person-assigned-select').value,
                 clientContacted: document.getElementById('sot-client-contacted').checked,
                 contactNumber: document.getElementById('sot-contact-number').value,
                 onsiteMeeting: document.getElementById('sot-onsite-meeting').checked,
                 address: document.getElementById('sot-address').value,
                 feedback: document.getElementById('sot-feedback').value,
                 status: document.querySelector('#sot-status-buttons .status-btn-active').dataset.status
             };
             showConfirmationModal(`Are you sure you want to ${action} this SOT record?`, () => {
                if(action === 'add') {
                    sotRecords.push(recordData);
                } else {
                    const index = sotRecords.findIndex(r => r.id == recordId);
                    if (index !== -1) sotRecords[index] = recordData;
                }
                resetSotForm();
                showSuccessModal('Success', `SOT record ${action === 'add' ? 'saved' : 'updated'}.`);
                renderSotRecordsTable();
            });
        };
        
        window.handleDeleteRecoveryRecord = (recordId) => {
            const record = recoveryRecords.find(r => r.id == recordId);
            if (record) {
                showConfirmationModal(`Are you sure you want to delete this recovery record?`, () => {
                    recoveryRecords = recoveryRecords.filter(r => r.id != recordId);
                    renderRecoveryRecordsTable();
                    showSuccessModal('Success', 'Record deleted.');
                });
            }
        };
        window.handleDeleteComplaintRecord = (recordId) => {
            const record = complaintRecords.find(r => r.id == recordId);
            if (record) {
                showConfirmationModal(`Are you sure you want to delete complaint #${record.refNumber}?`, () => {
                    complaintRecords = complaintRecords.filter(r => r.id != recordId);
                    renderComplaintsRecordsTable();
                    showSuccessModal('Success', 'Record deleted.');
                });
            }
        };
        window.handleDeletePositiveArrestRecord = (recordId) => {
            const record = arrestRecords.find(r => r.id == recordId);
            if (record) {
                showConfirmationModal(`Are you sure you want to delete this arrest record?`, () => {
                    arrestRecords = arrestRecords.filter(r => r.id != recordId);
                    renderArrestRecordsTable();
                    showSuccessModal('Success', 'Record deleted.');
                });
            }
        };
        window.handleDeleteSotRecord = (recordId) => {
            const record = sotRecords.find(r => r.id == recordId);
             if (record) {
                showConfirmationModal(`Are you sure you want to delete this SOT record?`, () => {
                    sotRecords = sotRecords.filter(r => r.id != recordId);
                    renderSotRecordsTable();
                    showSuccessModal('Success', 'Record deleted.');
                });
            }
        };
        

        initApp();
    </script>
</body>
</html>

